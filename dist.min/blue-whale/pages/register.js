define("RegPage",["require","exports","BwRule","Modal","ShellAction","UnBinding"],function(e,t,r,s,i,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=BW.sys,d=BW.CONF,c=G.d,v=G.tools,n=G.Shell,l=function(){function e(n){var t=this;this.props=n,this.deviceData={};var l=this;l.getDevice(),c.on(n.goLogin,"click",function(){o.window.load(d.url.login)}),v.isMb&&(this.code=this.renderCheckCode(n.verifyELCode),c.on(n.verifyELCode.parentElement,"click",function(){var e=h("canvas",{width:"80",height:"30"});c.replace(e,n.verifyELCode),n.verifyELCode=e,t.code=t.renderCheckCode(n.verifyELCode)})),c.on(n.saveReg,"click",function(){0!==n.tel.value.trim().length?n.verifyELCodeInput&&!l.confirmLocalCode()||(0!==n.smsCheckCode.value.trim().length?r.BwRule.Ajax.fetch(d.ajaxUrl.register,{type:"POST",data:{check_code:n.smsCheckCode.value,mobile:n.tel.value,uuid:t.deviceData.uuid,os_name:t.deviceData.name,os_version:t.deviceData.version,model:t.deviceData.model,vendor:t.deviceData.vendor,screen_width:t.deviceData.resolutionWidth,screen_height:t.deviceData.resolutionHeight,screen_size:t.deviceData.scale,support_finger:"1",finger_type:"1"},data2url:!0}).then(function(e){var t=e.response;-1<t.msg.indexOf("成功")?(s.Modal.toast("注册成功!"),o.window.logout()):s.Modal.confirm({msg:t.msg,btns:["取消","前往解绑"],callback:function(e){!0===e&&new a.UnBinding(t.data)}})}):s.Modal.alert("请输入短信验证码")):s.Modal.alert("请输入手机号")}),c.on(n.sendVerify,"click",function(e){var t=this,a=G.tools.str.toEmpty(n.tel.value);if(!G.tools.isEmpty(a)&&G.tools.valid.isTel(a)){if(!n.verifyELCodeInput||l.confirmLocalCode()){var i=60;t.classList.add("disabled"),t.innerHTML=i+"s";var o=setInterval(function(){0==--i?(clearInterval(o),t.classList.remove("disabled"),t.innerHTML="获取"):(t.classList.add("disabled"),t.innerHTML=i+"s")},1e3);r.BwRule.Ajax.fetch(d.ajaxUrl.smsSend,{data:{mobile:a,uuid:l.deviceData.uuid},data2url:!0,type:"POST",headers:{uuid:l.deviceData.uuid}}).then(function(){s.Modal.toast("验证码发送成功")}).catch(function(){}).finally(function(){t.innerHTML="获取",t.classList.add("disabled")}),e.stopPropagation()}}else s.Modal.alert("手机号格式有误")}),"pc"!==o.os&&(o.window.close=double_back)}return e.prototype.getDevice=function(){var a=this,e=i.ShellAction.get();if("ip"===o.os)e.device().getInfo({callback:function(e){var t=JSON.parse(e.detail);t.success?a.deviceData=t.msg:s.Modal.toast(t.msg)}});else if("ad"===o.os){var t=e.device().getInfo().data;t.success?this.deviceData=t.msg:s.Modal.toast(t.msg)}else"AppShell"in window?this.deviceData=n.base.device.data:"BlueWhaleShell"in window&&(this.deviceData=e.device().getInfo().data)},e.prototype.renderCheckCode=function(e){function a(e,t){return parseInt(Math.random()*(t-e)+e)}function t(e,t){return"rgb("+a(e,t)+","+a(e,t)+","+a(e,t)+")"}var i=e.getContext("2d"),o="",n=e.width,l=e.height;i.clearRect(0,0,n,l);for(var r="1234567890",s=0;s<4;s++){var d=r[a(0,r.length)];o+=d;var c=a(l/3*2,l),v=a(-30,30);i.font=c+"px Simhei",i.textBaseline="top",i.fillStyle=t(80,150),i.save(),i.translate(20*s+15,15),i.rotate(v*Math.PI/180),i.fillText(d,-10,-15),i.restore()}for(s=0;s<5;s++)i.beginPath(),i.moveTo(a(0,n),a(0,l)),i.lineTo(a(0,n),a(0,l)),i.strokeStyle=t(180,230),i.closePath(),i.stroke();for(s=0;s<40;s++)i.beginPath(),i.arc(a(0,n),a(0,l),1,0,2*Math.PI),i.closePath(),i.fillStyle=t(150,200),i.fill();return o},e.prototype.confirmLocalCode=function(){var e=this.props.verifyELCodeInput.value.toLowerCase();return this.code.toLowerCase()===e||(s.Modal.alert("验证码输入不正确"),!1)},e}();t.RegPage=l});