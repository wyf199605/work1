define(["require","exports","BasicPage","ShellAction","Modal","Finger","BwRule"],function(e,t,n,a,s,l,o){"use strict";var d=G.d,c=BW.CONF;return function(r){function e(e){var t=r.call(this,e)||this;t.para=e,t.shell=null,t.timer=null,t.fingerNode=null,t.shell=a.ShellAction.get();var n=e.dom.parentNode,i=n.offsetHeight-n.firstChild.offsetHeight;return e.dom.style.height=i+"px",t.initPage(),t}return __extends(e,r),e.prototype.initPage=function(){var e=this,t=e.para,n=d.create('<div class="attend-detail"></div>'),i=d.create('<div class="attend-content"><h4 class="datetime"></h4></div>');e.fingerNode=d.create('<div class="finger-content">\n                <p class="finger-title">考勤信息</p>\n                <p class="finger-msg">指纹机准备就绪，请按下手指...</p>\n            </div>');var r=d.create('<div class="attend-msg">\n                <ul class="list-msg"></ul>\n            </div>');i.appendChild(e.fingerNode),n.appendChild(i),t.dom.appendChild(n),t.dom.appendChild(r);var a=n.querySelector(".datetime");function s(){var e=new Date,t=function(e){return e<10?"0"+e:""+e};return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())}a.innerHTML=s(),e.timer=setInterval(function(){a.innerHTML=s()},1e3),e.attendFinger()},e.prototype.attendFinger=function(){var i=this,n=i.fingerNode.querySelector(".finger-msg"),r=i.fingerNode.querySelector(".finger-title"),a=new l.Finger({storeName:"fingers",version:3});a.callFinger=function(e){n.innerHTML="<span>"+e.msg+"</span>"},a.success=function(e){var t;n.innerHTML="<span>指纹获取成功，正在匹配中...</span>",t={userid:e.userid,fingerprint:e.print,fingertype:e.type,verify:e.verify},o.BwRule.Ajax.fetch(c.ajaxUrl.atdFingerAtd,{type:"POST",data:[t]}).then(function(e){var t=e.response,n=t.body.bodyList[0];i.addList(n),r.innerHTML='<span class="green">'+n.userName+n.result+"</span>",a.addFinger(n.fingerData)}).catch(function(){s.Modal.toast("考勤失败请重试"),r.innerHTML='<span class="red">考勤失败，请重新录入</span>'}).finally(function(){a.againOpen()})}},e.prototype.addList=function(e){var t=this.dom.querySelector(".list-msg"),n=d.create('<li class="animated">\n                        <span class="arrow">'+e.datetime+"</span>\n                        <span>"+(e.userName+e.result)+"</span></li>");t.insertBefore(n,t.firstChild);var i=setTimeout(function(){n.className="",clearTimeout(i)},1e3)},e.prototype.destroy=function(){clearInterval(this.timer),this.shell.erp().cancelFinger()},e}(n.default)});