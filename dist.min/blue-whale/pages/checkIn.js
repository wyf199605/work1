define(["require","exports","BasicPage","TextInput","Tab","Button","Modal","InputBox","BwRule","ShellAction"],function(e,t,n,i,o,s,d,a,u,y){"use strict";var l=G.d,g=BW.CONF,f=G.tools,w=G.Shell;return function(r){function e(e){var t=r.call(this,e)||this;t.para=e,t.passwordEl=null;var n=e.dom.parentNode,a=n.offsetHeight-n.firstChild.offsetHeight;return e.dom.style.height=a+"px",t.initPage(),t}return __extends(e,r),e.prototype.initPage=function(){var t=this,e=t.para,n=h("div",{class:"checkIn-detail"}),a=h("div",{class:"checkIn-content"},h("h4",{class:"datetime"}));t.passwordEl=h("div",{class:"password-content"},h("form",null,h("div",{class:"from-group"},h("div",{"data-type":"text",type:"text"}),h("div",{"data-type":"password",type:"text"}),h("div",{"data-type":"submit"}))));new i.TextInput({container:t.passwordEl.querySelector('[data-type="text"]'),type:"text",placeholder:"请输入用户名",icons:["iconfont icon-avatar"]}),new i.TextInput({container:t.passwordEl.querySelector('[data-type="password"]'),type:"password",placeholder:"请输入密码",icons:["iconfont icon-suo4"]}),new s.Button({container:t.passwordEl.querySelector("[data-type=submit]"),content:"确定",type:"primary"}),new o.Tab({tabParent:n,panelParent:a,tabs:[{title:"密码修改",dom:t.passwordEl},{title:"指纹登记",dom:h("div",{class:"register-finger"})}],onClick:function(e){1===e&&t.registerFinger()}});n.appendChild(a),e.dom.appendChild(n),this.registerPassword()},e.prototype.registerFinger=function(){var e=new a.InputBox({}),t=new s.Button({content:"取消",type:"danger",key:"cancelBtn"}),n=new s.Button({content:"确定",type:"primary",onClick:f.pattern.debounce(function(e){if(f.isEmpty(c.get()))d.Modal.toast("员工号不能为空");else{p.style.opacity="1";var t=c.get().toUpperCase();"AppShell"in window?function(i){var o=this,s=p.querySelector('[data-msg="msg"]');G.Shell.finger.cancel(),G.Shell.finger.get({type:1,option:1},function(e){if(console.log(e),e.success){var t=e.data,n=t.finger,a=t.fingerType;s.innerHTML="<span>指纹数据正在录入中，请稍后...</span>";var r=g.ajaxUrl.atdFingerReg;u.BwRule.Ajax.fetch(r,{type:"POST",data:[{userid:i,fingertype:a,fingerprint:n}]}).then(function(e){e.response;p.style.opacity="0",d.Modal.alert("指纹录入成功")}).catch(function(){d.Modal.alert("指纹录入失败")}).finally(function(){l.destroy(),c.set(""),w.finger.cancel()})}else w.finger.cancel(),s.innerHTML="<span>"+e.msg+"</span>",o.registerFinger()},function(e){s.innerHTML="<span>"+e.data.text+"</span>"},!0)}(t):"BlueWhaleShell"in window&&function(i){var e=y.ShellAction.get().erp(),o=this,s=p.querySelector('[data-msg="msg"]');e.callFinger({type:1}),e.callFingerMsg({callback:function(e){var t=JSON.parse(e.detail);s.innerHTML="<span>"+t.msg+"</span>"}}),e.setFinger({callback:function(e){var t=JSON.parse(e.detail),n=t.msg.fingerPrint,a=t.msg.fingerType;if(t.success){s.innerHTML="<span>指纹数据正在录入中，请稍后...</span>";var r=g.ajaxUrl.atdFingerReg;u.BwRule.Ajax.fetch(r,{type:"POST",data:[{userid:i,fingertype:a,fingerprint:n}]}).then(function(e){e.response;p.style.opacity="0",d.Modal.alert("指纹录入成功")}).catch(function(){d.Modal.alert("指纹录入失败")}).finally(function(){l.destroy(),c.set(""),y.ShellAction.get().erp().cancelFinger()})}else y.ShellAction.get().erp().cancelFinger(),s.innerHTML="<span>"+t.msg+"</span>",o.registerFinger()}})}(t)}},500)});e.addItem(n),e.addItem(t);var l=new d.Modal({header:"注册指纹",body:h("div",{class:"main",style:"padding:13px 18px"},h("div",{class:"form"},h("div",{"data-type":"text",style:"border:1px solid #ccc;border-radius:5px;"}),h("p",{class:"help-block"},"输入员工号后按确定录入指纹"),h("div",{"data-type":"button"})),h("div",{style:"opacity:0;transition:1s",class:"finger"},h("h4",null,"请按下指纹"),h("p",{"data-msg":"msg"}))),footer:{rightPanel:e},onClose:function(){"AppShell"in window?w.finger.cancel():"BlueWhaleShell"in window&&y.ShellAction.get().erp().cancelFinger()}}),p=l.bodyWrapper.querySelector(".finger"),c=new i.TextInput({container:l.bodyWrapper.querySelector('[data-type="text"]'),type:"text"});c.focus()},e.prototype.registerPassword=function(){var r=this.passwordEl.querySelector("form");r.querySelector("[data-type=submit]>button").type="submit",l.on(r,"submit",function(e){e.preventDefault();var n=r.querySelector("input[type=text]").value.toUpperCase(),t=r.querySelector("input[type=password]").value;if(f.str.toEmpty(n)&&f.str.toEmpty(t)){var a=g.ajaxUrl.atdPwdReg;u.BwRule.Ajax.fetch(g.ajaxUrl.passwordEncrypt,{data:{str:t}}).then(function(e){var t=e.response.body.bodyList[0];return u.BwRule.Ajax.fetch(a,{type:"POST",data:JSON.stringify({userid:n,password:t})})}).then(function(e){var t=e.response;t.msg;r.querySelector("input[type=text]").value="",r.querySelector("input[type=password]").value="",d.Modal.toast(t.msg)})}else d.Modal.alert("密码不能为空")})},e.prototype.destroy=function(){w.finger.cancel()},e}(n.default)});