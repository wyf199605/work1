define("RfidBing",["require","exports","Modal","FastTable","MbPage","Button","BwRule"],function(t,n,s,a,i,d,u){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var e=G.Component,f=G.d,b=G.tools,y=BW.sys,r=function(a){function t(t){var n=this,e=new o(t);return n=a.call(this,{isShow:!0,height:"100%",width:"100%",className:"bind-report",position:"down"})||this,new i.MbPage({container:n.bodyWrapper,body:e.wrapper,title:"解绑/绑定",left:[{icon:"mui-icon-left-nav",iconPre:"mui-icon",onClick:function(){n.isShow=!1}}]}),n.epcList=e,n}return __extends(t,a),t.prototype.destroy=function(){a.prototype.destroy.call(this),this.epcList.destroy(),this.epcList=null},t}(s.Modal);n.RfidBingModal=r;var o=function(e){function t(t){var n=e.call(this,t)||this;return n.turn=!1,n.bindtimer=null,n.bindBarTime=null,n.bingCell={},n.tableInit(),n.btnInit(t.bindBtn),n.getSku(t.bindBtn.type),n.judge(t),n.colConfig(t.bindBtn),n}return __extends(t,e),t.prototype.wrapperInit=function(t){return h("div",{className:"rfid-bing-page"},h("div",{className:"bind-screen-top"},h("label",null,"SKU",this.skuEl=h("input",{type:"text"})),h("div",{className:"bind-data"},h("div",{className:"bind-tied-up"},"0"==t.bindBtn.type?"已解绑":"已绑定"," : ",this.boundEl=h("span",null,"0")),h("div",{className:"bing-scanning"},"扫描量: ",this.scanNumEl=h("span",null,"0")))))},t.prototype.btnInit=function(t){var o=this,n=h("div",{className:"rfid-bing-btns"}),e=t.caption,a=b.isNotEmpty(t.param)?t.param:{},i=b.url.addObj("/inventoryrfid/import/"+t.itemid+"/"+t.elementid,a),l=this.ftable,c=this.scanNumEl,r=this.boundEl,p=new d.Button({container:n,content:"开始扫描",onClick:function(){"开始扫描"===p.content?(G.Shell.inventory.startEpc({},function(t){var r=t.data;Array.isArray(r)&&(r.forEach(function(t){for(var n=t.epc,e=o.ftable.data,a=!0,i=0;i<e.length;i++)if(n==e[i].epc){a=!1;break}a&&(l.dataAdd(r),c.innerHTML=parseInt(c.innerHTML)+r.length+"")}),b.pattern.debounce(o.senData,500))}),o.updataCellData(t),p.content="停止扫描"):(console.log(o.ftable.data),clearInterval(o.bindBarTime),G.Shell.inventory.stopEpc({},function(t){}),p.content="开始扫描")}});new d.Button({container:n,content:"清除数据",onClick:function(){l.data=[],c.innerHTML="0",G.Shell.inventory.clearEpc([],function(t){t&&(l.data=[])})}}),new d.Button({container:n,content:e,onClick:function(){u.BwRule.Ajax.fetch(BW.CONF.siteAppVerUrl+i,{type:"post",data:{info:"0"===t.type?{epc:o.ftable.data.filter(function(t){return!!t}).map(function(t){return t.epc})}:{sku:o.skuEl.value,epc:o.ftable.data.filter(function(t){return!!t}).map(function(t){return t.epc})}}}).then(function(t){var n=t.response;n&&(G.Shell.inventory.clearEpc([],function(t){t&&(s.Modal.alert(n.msg,"",function(){"报废"!==e&&"调出"!==e&&"调入"!==e||y.window.close()}),r.innerHTML=o.ftable.data.length+parseInt(r.innerHTML)+"",l.data=[],c.innerHTML="0")}),y.window.firePreviousPage(u.BwRule.EVT_REFRESH))})}});f.append(this.wrapper,n)},t.prototype.tableInit=function(){var i=new a.FastTable({container:this.wrapper,cols:[[{name:"epc",title:"EPC"}]],page:{size:50},cellFormat:function(t){var n=document.createDocumentFragment();return f.append(n,t),f.append(n,h("div",{className:"delete"},"x")),{text:n}}}),r=this;i.click.add("tr>td>.delete",function(){var t=this.parentElement.parentElement,n=parseInt(t.dataset.index),e=[];r.scanNumEl.innerHTML=parseInt(r.scanNumEl.innerHTML)-1+"";var a=i.rowGet(n).data;G.tools.isNotEmpty(a)&&e.push(a),i.rowDel([n]),G.Shell.inventory.clearEpc(e,function(t){})}),this.ftable=i},t.prototype.getSku=function(t){var n=this;"1"===t&&G.Shell.inventory.openScan(function(t){t.data&&"openSuponScan"!==t.data&&(n.skuEl.value=t.data)})},t.prototype.judge=function(t){"0"===t.bindBtn.type&&(f.query(".bind-screen-top>label",this.wrapper).style.display="none"),t.bindBtn.nohead&&(f.query(".bind-data > .bind-tied-up",this.wrapper).style.display="none")},t.prototype.colConfig=function(t){var i=this,n=b.isNotEmpty(t.param)?t.param:{},e=b.url.addObj("/inventoryrfid/getdata/"+t.itemid+"/"+t.elementid,n),r=f.query(".bind-data",this.wrapper),o=document.createDocumentFragment();u.BwRule.Ajax.fetch(BW.CONF.siteAppVerUrl+e).then(function(t){var n=t.response;if(console.log(n.body.bodyList),b.isNotEmpty(n.body.bodyList)){for(var e=n.body.bodyList,a=0;a<e.length;a++)e[a].forEach(function(t){var n=h("div",{className:t.calcField},t.calcCaption," : ",h("span",null,t.calcValue));i.bingCell[t.calcField]=f.query("span",n),f.append(o,n)});console.log(i.bingCell),f.append(r,o)}})},t.prototype.updataCellData=function(t){var i=this,n=b.isNotEmpty(t.param)?t.param:{},e=b.url.addObj("/inventoryrfid/getdata/"+t.itemid+"/"+t.elementid,n);this.bindBarTime=setInterval(function(){u.BwRule.Ajax.fetch(BW.CONF.siteAppVerUrl+e,{type:"post",data:{info:"0"===t.type?{epc:i.ftable.data.filter(function(t){return!!t}).map(function(t){return t.epc})}:{sku:i.skuEl.value,epc:i.ftable.data.filter(function(t){return!!t}).map(function(t){return t.epc})}}}).then(function(t){var n=t.response;if(b.isNotEmpty(n.body.bodyList)){var e=n.body.bodyList;console.log(e);for(var a=0;a<e.length;a++)e[a].forEach(function(t){i.bingCell[t.calcField].innerHTML=t.calcValue+""})}else clearInterval(i.bindtimer)})},1009)},t.prototype.senData=function(t){var n=b.isNotEmpty(t.param)?t.param:{},e=b.url.addObj("/inventoryrfid/getdata/"+t.itemid+"/"+t.elementid,n);u.BwRule.Ajax.fetch(BW.CONF.siteAppVerUrl+e,{type:"post",data:{info:"0"===t.type?{epc:this.ftable.data.filter(function(t){return!!t}).map(function(t){return t.epc})}:{sku:this.skuEl.value,epc:this.ftable.data.filter(function(t){return!!t}).map(function(t){return t.epc})}}}).then(function(t){t.response})},t}(e);n.EpcList=o});