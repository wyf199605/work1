define("mainPage",["require","exports","SideBarMrg","Modal","User","Device","SearchInput","Loading","BwRule","Popover"],function(e,t,a,r,n,o,c,s,l,i){"use strict";var u,d=G.tools,f=BW.sys,p=BW.CONF,h=G.localMsg,v=G.d;return(u=function(){function t(){}return t.init=function(e){t.pageContainer=e.pageContainer,t.navBar=e.navBar,t.tabContainer=e.navBar.querySelector("ul.page-tabs-content"),t.sidsBar=new a.default({menu:e.menu,shortMenu:e.shortMenu,favUrl:p.ajaxUrl.menuFavor,recentUrl:p.ajaxUrl.menuHistory,menuUrl:p.ajaxUrl.menu}),t.topNavMenu.init(),t.myselfMenu.init(),t.rightSidebar.init(),t.search.init(e)},t}()).sidsBar=null,u.tabContainer=null,u.search=function(){var i=new l.BwRule.Ajax;function t(o){new c.SearchInput({container:o.searchDom,className:"search-form",placeholder:"搜索",ajax:{url:o.baseUrl,fun:function(e,t,a,n){u.spinner?u.spinner.show():u.spinner=new s.Loading({}),i.fetch(p.siteUrl+o.baseUrl,{type:"POST",data2url:!0,cache:!0,data:{currentNode:o.nodeId,keywords:a}}).then(function(e){!function(e){var n=document.createDocumentFragment(),t=v.create("<div></div>");e?e.forEach(function(e){var t,a;n.appendChild((a=(t=e).menuItem,v.create('  <div class="file-box col-xs-2 col-md-2 card-white" data-favid="'+a.favid+'">\n                    <div class="file" title="'+t.menuLocation+'">\n                        <a data-href="'+a.menuPath.dataAddr+'" >\n                            <span class="corner"></span>\n                            <span data-url="'+a.subScriptUrl+'" class="partition-red hide"></span>\n                            <div class="icon">\n                                <i class="ti '+a.menuIcon+'"></i>\n                            </div>\n                            <div class="file-name">'+a.menuName+"</div>\n                        </a>\n                    </div>\n                </div>")))}):n.appendChild(v.create("<div>暂无数据</div>"));t.appendChild(n),u.searchModal?(u.searchModal.body=t,u.searchModal.isShow=!0):(u.searchModal=new r.Modal({header:"菜单搜索结果",position:"left",className:"menuPage",body:t,isBackground:!1}),u.searchModal.body.parentElement.classList.add("padding-1"));v.on(t,"click","a[data-href]",function(){u.searchModal.isShow=!1;var e=this.querySelector("[data-url]"),t=0;e&&(t=parseInt(e.textContent));var a=e?{badge:t}:{};BW.sys.window.open({url:p.siteUrl+this.dataset.href,data:a})}),u.spinner.hide()}(e.response.body.bodyList)})}}})}return{init:function(e){t(e)}}}(),u.topNavMenu={init:function(){var n,i,r,e,o;i=u.navBar,r=u.tabContainer,e=r.parentElement.parentElement,u.pageContainer,o=function(){var n=$(r.parentElement);function o(e){n.animate({scrollLeft:e})}function e(){var e,t,a=r.querySelector("li.open");a&&(e=a.offsetLeft+a.offsetWidth,t=i.offsetWidth,(e<0||t<e)&&o(e+n.scrollLeft()-t+20))}function t(){i.classList[r.offsetWidth>i.offsetWidth?"add":"remove"]("hover")}return{left:function(){o(n.scrollLeft()-500)},right:function(){o(n.scrollLeft()+500)},toActive:function(){e()},toggleBtn:function(){t()},calc:function(){e(),t()}}}(),n=f.window.open,f.window.open=function(e,t){e.callback="function"==typeof e.callback?e.callback:function(){};var a=e.callback;e.callback=function(){o.calc(),a()},n(e,t),o.calc()},o.calc(),v.on(e,"click",".tab-ctl-btn",function(){this.classList.contains("J_tabLeft")?o.left():o.right()}),$(r).on("click","li[data-href]",function(){f.window.open({url:this.dataset.href})}).on("click",".close[data-href]",function(e){f.window.close("",null,this.dataset.href),o.toggleBtn(),e.stopPropagation()}),v.on(v.query(".topControlBtns"),"click","li[data-close]",function(){switch(this.dataset.close){case"focusCur":o.toActive();break;case"closeAll":f.window.closeAll();break;case"closeOther":f.window.closeOther()}})}},u.myselfMenu=function(){var e=[{title:'<a href="javascript:void(0)" data-page-name="myself" data-action="myself">个人资料</a>'},{title:'<a href="javascript:void(0)" data-action="account">账号与安全</a>'},{title:'<a href="javascript:void(0)" data-action="check">检查新版本</a>'},{title:'<a href="javascript:void(0)" data-action="clear">清理缓存</a>'},{title:'<a href="javascript:void(0)" data-page-name="bugReport" data-action="bugReport">故障申告</a>'}];function t(){var t=new i.Popover({target:v.query(".popover-toggle"),isWatch:!0,items:e,isBackground:!1,onClick:function(e){switch(t.show=!1,v.query("a",this).dataset.action){case"myself":f.window.open({url:d.url.addObj(p.url.myself,{userid:n.User.get().userid})});break;case"account":break;case"check":f.window.update();break;case"clear":f.window.clear();break;case"bugReport":f.window.open({url:p.url.bugReport});break;case"changePassword":f.window.open({url:p.url.changePassword});break;case"logout":r.Modal.confirm({msg:"您确定要退出登录吗",callback:function(e){if(e){o.Device.get();f.window.logout()}}})}}})}return"app_fastlion_retail"===p.appid?e=e.concat([{title:'<a href="javascript:void(0)" data-page-name="changePassword" data-action="changePassword">修改个人密码</a>'},{title:'<a data-action="logout">退出登录</a>'}]):e.push({title:'<a data-action="logout">退出登录</a>'}),{init:function(){$(".messageList").on("click","li",function(){var e=p.siteUrl+$(this).data("url");f.window.open({url:e}),$(this).remove(),h.remove(this.dataset.notifyid)}),document.querySelector("[data-action=topSeeAllMsg]").addEventListener("click",function(){f.window.open({url:p.url.message})}),t()}}}(),u.rightSidebar=function(){$("html"),$(window),$(".app-aside"),$("#app");return{init:function(){var r;(r=$("*[data-toggle-class]")).each(function(){var t,a,n=$(this),o=n.attr("data-toggle-class");a=void 0!==n.attr("data-toggle-target")?$(n.attr("data-toggle-target")):n,n.on("click",function(e){"undefined"!==n.attr("data-toggle-type")&&"on"==n.attr("data-toggle-type")?a.addClass(o):"undefined"!==n.attr("data-toggle-type")&&"off"==n.attr("data-toggle-type")?a.removeClass(o):a.toggleClass(o),e.preventDefault(),n.attr("data-toggle-click-outside")&&(t=$(n.attr("data-toggle-click-outside")),$(document).on("mousedown touchstart",i))});var i=function(e){0!==t.has(e.target).length||t.is(e.target)||r.is(e.target)||!a.hasClass(o)||(a.removeClass(o),$(document).off("mousedown touchstart",i))}})}}}(),u}),define("SideBarMrg",["require","exports","BwRule","DragDeform","Menu"],function(e,t,i,a,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=G.tools,o=BW.sys,c=BW.CONF,s=G.d,l=BW.sysPcHistory,u=function(){function e(e){this.para=e,this.menu=null,this.favRecTree=null,this.openWindow=function(e,t){0<=l.indexOf(e)&&o.window.refresh(e),o.window.open({url:e,title:t})},this.initMainNavMenu(),this.initFavRecent(),setTimeout(function(){new a.DragDeform({dragDom:s.query("#sidebar"),border:["right"],minWidth:190,maxWidth:290}),s.on(s.query("#msgVersion"),"click",".button-o",function(){o.window.open({url:c.url.msgVersion})})},10)}return e.prototype.initMainNavMenu=function(){var n=this,o=e.loadTpl();s.append(this.para.menu,o),this.menu=new r.Menu({expand:!0,container:this.para.menu,isAccordion:!0,content:this.para.menuUrl,isLeaf:!1,ajax:function(e){var t=e.content,a="string"==typeof t?t:c.siteUrl+i.BwRule.reqAddr(e.content.menuPath);return Promise.resolve(i.BwRule.Ajax.fetch(a,{data:{output:"json"}}).then(function(e){var t=e.response;return o&&(s.remove(o),o=null),n.convertToTreePara(t)}))}}),this.menu.onOpen=function(e){if(e.isLeaf){var t=e.content.menuPath;if(t){var a=c.siteUrl+i.BwRule.reqAddr(t);n.openWindow(a,e.content.menuName)}}}},e.prototype.initFavRecent=function(){var t=this;this.favRecTree=new r.Menu({text:"virtualNode",container:this.para.shortMenu,isAccordion:!0,expand:!0,children:[{text:"最近",icon:"ti-time",isLeaf:!1,ajax:function(){return t.recFavMenuGet("recent")}},{text:"收藏",icon:"ti-save",isLeaf:!1,ajax:function(){return t.recFavMenuGet("fav")}}]}),this.favRecTree.onOpen=function(e){e.isLeaf&&t.openWindow(c.siteUrl+e.content.url,e.content.caption)}},e.prototype.recFavMenuGet=function(e){var n="fav"===e;return i.BwRule.Ajax.fetch(this.para[n?"favUrl":"recentUrl"],{data:{action:"query"}}).then(function(e){var t=e.response.data,a=[];if(Array.isArray(t))return n?t.forEach(function(e){var t={text:e.tag||"默认分组",expand:!0,icon:"ti-folder",ajax:!1};Array.isArray(e.favs)&&(t.children=e.favs.map(function(e){return o(e)})),a.push(t)}):a=Array.isArray(t)?t.map(function(e){return o(e)}):[],a}).catch(function(){return null});function o(e){return{text:e.caption,icon:e.icon,content:e,isLeaf:!0,ajax:!1}}},e.prototype.convertToTreePara=function(e){var t=e.body.elements;return n.isEmpty(t)?null:t.map(function(e){return{text:e.menuName,icon:G.tools.str.removeEmpty(e.menuIcon),isLeaf:!!e.menuType,content:e}})},e.prototype.initTree=function(e){},e.loadTpl=function(){return s.create('<div class="loadSpinner"><span class="spinner"></span><span class="loadTitle">加载中....</span></div>')},e}();t.default=u});