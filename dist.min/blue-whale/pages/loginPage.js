define(["require","exports","Rule","Modal","User","Device"],function(e,i,o,r,n,a){"use strict";var d=G.sys,c=G.tools,l=G.conf,u=G.d;return function(){function e(e){var n=this;this.props=e,this.loginByFinger=function(){var s,t=n;if(t.validReg()){var a=new r.Modal({title:"指纹登录",body:u.createByHTML('<div data-action="fingerModal">\n                          <input type="text" >\n                          <i class="iconfont icon-zhiwen red block margin-bottom-10" style="font-size:2em;"></i>\n                          <p style="float:left;margin-top:6px;margin-left:10px;max-width:230px;"></p>\n                        </div>')});s=a.body.querySelector("p");var e={success:!1,msg:"必须在客户端内使用"};"BlueWhaleShell"in window&&(e=JSON.parse(BlueWhaleShell.postMessage("callFinger",'{"type":"0"}'))),e.success?s.innerHTML="<span >"+e.msg+"</span><br/>":s.innerHTML='<span class="red">'+e.msg+"</span><br/>",window.addEventListener("callFingerMsg",function(e){var i=JSON.parse(e.detail);i.success?s.innerHTML="<span>"+i.msg+"</span><br/>":s.innerHTML='<span class="red">'+i.msg+"</span><br/>"}),window.addEventListener("setFinger",function(e){var i=JSON.parse(e.detail);i.success?(s.innerHTML="<span>指纹获取成功开始匹配</span><br/>",a.isShow=!1,t.ajaxLogin(l.ajaxUrl.loginFinger,{userid:a.body.querySelector("input").value.toUpperCase(),fingerPrint:i.msg.fingerPrint,fingerType:i.msg.fingerType})):s.innerHTML='<span class="red">'+i.msg+"</span><br/>"})}},this.TouchidClick=function(){var s=n;s.validReg()&&d.window.touchid(function(e){var i=JSON.parse(e.detail);i.success?o.Rule.ajax(l.ajaxUrl.passwordEncrypt+"?str="+s.device.auth_code,{success:function(e){var i=e.body.bodyList[0];s.ajaxLogin(s.props.loginUrl.touch,{password:i})}}):1==i.msg?r.Modal.toast("指纹匹配不正确"):2==i.msg?r.Modal.toast("该设备不支持指纹"):r.Modal.toast(i.msg)})},this.wechatChick=function(){n.validReg()&&("ad"!==d.os&&"ip"!==d.os||d.window.wechatin(function(e){var i=JSON.parse(e.detail);i.success?n.ajaxLogin(l.ajaxUrl.loginWeiXin,{openid:i.msg.unionid}):1==i.msg?r.Modal.toast("操作取消"):2==i.msg?r.Modal.toast("登录请求被微信拒绝"):3==i.msg?r.Modal.toast("请安装微信客户端后再使用"):r.Modal.toast(i.msg)}))},this.loginClick=function(){var s=n,e=s.props.saveButton,i=d.isMb?e.classList.contains("mui-active"):e.checked,t=s.props.password.value,a=s.props.userId.value.replace(/\s+/g,"");c.valid.isEmpty(a)?r.Modal.toast("请填写用户名"):c.valid.isEmpty(t)?r.Modal.toast("请填写密码"):(s.device.isSavePassword=i,o.Rule.ajax(l.ajaxUrl.passwordEncrypt+"?str="+t,{success:function(e){var i=e.body.bodyList[0];s.ajaxLogin(s.props.loginUrl.password,{userid:a.toUpperCase(),password:i},function(){s.device.userid=a.toUpperCase(),s.device.password=t})}}))};var i=e.responseBean;if(this.device=new a.Device,this.deviceUpdate(),i&&i.body&&i.body.bodyList&&i.body.bodyList[0]){var s=i.body.bodyList[0].dataList,t=i.body.bodyList[0].meta;i.data=o.Rule.getCrossTableData(t,s),i.data&&i.data[0]&&i.data[0].AUTH_CODE?this.device.auth_code=i.data[0].AUTH_CODE:this.device.auth_code=""}else this.device.auth_code="";this.loadPassword(),this.initEvent(e),d.isMb&&(d.window.close=double_back)}return e.prototype.ajaxLogin=function(e,i,s){var t=this;if(!t.props.loginButton.classList.contains("disabled")){t.loginBtnState(1);var a=c.url.addObj(e,i);o.Rule.ajax(a,{type:"post",data:"["+JSON.stringify(i)+"]",headers:{auth_code:t.device.auth_code,uuid:t.device.uuid},success:function(e){t.loginBtnState(10),"function"==typeof s&&s(),e.data.forEach(function(e,i){var s=new n.User;"are_id"===e.NAME?s.are_id=e.CAPTION:"userid"===e.NAME?s.userid=e.CAPTION:"USERNAME"===e.NAME?(s.department=e.CAPTION,s.username=e.VALUE):e.NAME}),d.window.opentab()},error:function(){t.loginBtnState(0)},netError:function(){t.loginBtnState(0)}})}},e.prototype.initEvent=function(e){var i=this;e.regButton&&u.on(e.regButton,"click",function(){c.valid.isEmpty(i.device.auth_code)?d.window.load(l.url.reg):r.Modal.toast("您的设备已注册")}),e.loginButton&&u.on(e.loginButton,"click",i.loginClick),e.wxButton&&u.on(e.wxButton,"click",i.wechatChick),e.fingerMbBtn&&u.on(e.fingerMbBtn,"click",i.TouchidClick),e.fingerPcBtn&&u.on(e.fingerPcBtn,"click",i.loginByFinger);var s=0;document.querySelector("[data-action=selectServer]").addEventListener("click",function(){5===(s+=1)&&(d.window.load(l.url.selectServer),s=0)})},e.prototype.validReg=function(){return!c.valid.isEmpty(this.device.auth_code)||(r.Modal.confirm({msg:"设备未注册",btns:["取消","前往注册"],callback:function(e){!0===e&&d.window.load(l.url.reg)}}),!1)},e.prototype.loginBtnState=function(e){var i=this.props.loginButton,s=d.isMb?i:i.querySelector(".text");switch(e){case 0:i.classList.remove("disabled"),s.innerHTML="登录";break;case 1:i.classList.add("disabled"),d.isMb?s.innerHTML='<span style="width:22px;height:22px;vertical-align:sub" class="mui-spinner"></span> 登录中...':s.innerHTML="登录中...";break;case 10:i.classList.remove("disabled"),s.innerHTML="登录成功"}},e.prototype.loadPassword=function(){var e=this.props.saveButton;this.device.isSavePassword&&(d.isMb?e.classList.add("mui-active"):e.checked=!0,this.props.userId.value=c.str.toEmpty(this.device.userid),this.props.password.value=c.str.toEmpty(this.device.password))},e.prototype.deviceUpdate=function(){var s=this;if("BlueWhaleShell"in window){var e=BlueWhaleShell.postMessage("getVersion","");o.Rule.ajax(l.ajaxUrl.pcVersion,{data:{getversion:e},silent:!0,success:function(e){BlueWhaleShell.postMessage("downloadFile",JSON.stringify(e.data[0]))}});var i=BlueWhaleShell.postMessage("getDevice","");c.valid.isEmpty(i)?r.Modal.toast("获取不到设备信息"):this.device.uuid=JSON.parse(i).msg.uuid}else"ip"===d.os?(d.window.getDevice("uuid"),window.addEventListener("getDevice",function(e){var i=JSON.parse(e.detail);i.success?s.device.uuid=i.msg.uuid:r.Modal.toast(i.msg)})):"ad"===d.os&&(this.device.uuid=d.window.getDevice("uuid").msg)},e}()});