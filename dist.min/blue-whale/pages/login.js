define("LoginPage",["require","exports","Modal","User","Device","BwRule","CheckBox","Button","FqaModal","UnBinding","NewFinger"],function(e,t,d,r,a,l,s,u,c,p,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var f=BW.sys,v=G.tools,g=BW.CONF,h=G.d,y=G.Shell,i=function(){function e(e){var n=this;this.props=e,this.wechatChick=function(){n.validReg()&&("ad"!==f.os&&"ip"!==f.os||f.window.wechatin(function(e){var t=JSON.parse(e.detail);t.success?n.ajaxLogin(g.ajaxUrl.loginWeiXin,{openid:t.msg.unionid}):1==t.msg?d.Modal.toast("操作取消"):2==t.msg?d.Modal.toast("登录请求被微信拒绝"):3==t.msg?d.Modal.toast("请安装微信客户端后再使用"):d.Modal.toast(t.msg)}))};var t=e.responseBean;if(this.device=a.Device.get(),this.deviceUpdate(),t&&t.body&&t.body.bodyList&&t.body.bodyList[0]){var i=t.body.bodyList[0].dataList,o=t.body.bodyList[0].meta;t.data=l.BwRule.getCrossTableData(o,i),t.data&&t.data[0]&&t.data[0].AUTH_CODE?this.device.auth_code=t.data[0].AUTH_CODE:this.device.auth_code=""}else this.device.auth_code="";this.loadPassword(),this.initEvent(e),f.isMb&&(f.window.close=double_back)}return e.prototype.phoneVerify=function(){var o=this,e=h.create('<div class="login-wrapper modal-body-login"></div>'),t=h.create('<div class="login-title">短信验证码登录</div>'),n=h.create('\n        <form action="#" class="login-form">\n            <div class="form-group">\n                <input class="tel" type="text" placeholder="请输入手机号码"/>\n            </div>\n            <div class="form-group">\n                <input class="code" type="text" placeholder="请输入短信验证码"/>\n            </div>\n            <div class="btn-group"></div>\n        </form>'),a=h.query(".tel",n),s=h.query(".code",n),i=new u.Button({container:s.parentElement,content:"获取验证码",className:"get-code-btn",onClick:function(){if(v.valid.isTel(a.value)){var e=60;i.isDisabled=!0,i.content=e+"s后重新获取";var t=setInterval(function(){0===--e?(clearInterval(t),i.content="获取验证码",i.isDisabled=!1):i.content=e+"s后重新获取"},1e3);l.BwRule.Ajax.fetch(g.ajaxUrl.smsSend,{data:{mobile:a.value,uuid:o.device.uuid},data2url:!0,type:"POST",headers:{uuid:o.device.uuid}}).catch(function(){clearInterval(t),i.content="获取验证码",i.isDisabled=!1})}else d.Modal.alert("请输入正确的手机号码")}}),r=new u.Button({container:h.query(".btn-group",n),content:"登录",className:"login-submit"});r.wrapper.type="submit",h.append(e,t),h.append(e,n);new d.Modal({container:document.body,header:" ",body:e,position:v.isMb?"full":"",width:"730px",isShow:!0,isOnceDestroy:!0,className:"sms-login"});h.on(n,"submit",function(e){e.preventDefault();var i=a.value,t=s.value;v.valid.isTel(i)?v.isEmpty(t)?d.Modal.alert("请输入短信验证码"):(r.isLoading=!0,r.isDisabled=!0,r.content="登陆中...",o.ajaxLogin(g.ajaxUrl.loginCode,{mobile:i,check_code:t},function(n){return new Promise(function(e,t){n.success?o.bindWeChat(i,function(){return e()}):e()})}).then(function(){r.isLoading=!1,r.content="登陆成功"}).catch(function(){r.isLoading=!1,r.isDisabled=!1,r.content="登录"})):d.Modal.alert("请输入正确的手机号码")})},e.prototype.bindWeChat=function(i,o){var a=function(){f.window.wechatin(function(e){var t=JSON.parse(e.detail);if(t.success){var n=Object.assign({},t.msg||{},{mobile:i});l.BwRule.Ajax.fetch(BW.CONF.ajaxUrl.bindWeChat,{type:"post",timeout:1500,data:[n]}).then(function(e){e.body&&v.isNotEmpty(e.body)?(d.Modal.toast("绑定成功！"),o()):s()}).catch(function(){s()})}else s()})},s=function(){d.Modal.confirm({msg:"绑定失败，是否重新绑定？",callback:function(e){e?a():o()}})};l.BwRule.Ajax.fetch(BW.CONF.ajaxUrl.bindWeChat,{data:{mobile:i}}).then(function(e){var t=e.response,n=t.body||{},i=(n.bodyList?n.bodyList[0]:{}).flag;1===i?o():2===i?d.Modal.confirm({msg:"您的手机尚未绑定微信，是否需要绑定微信账号？",callback:function(e){e?a():o()}}):d.Modal.alert(t.msg,"温馨提示",function(){o()})}).catch(function(e){o()})},e.prototype.unBindling=function(){var n=this,e=h.create('<div class="login-wrapper modal-body-login"></div>'),t=h.create('<div class="login-title">短信获取解绑信息</div>'),i=h.create('\n        <form action="#" class="login-form">\n            <div class="form-group">\n                <input class="user" type="text" placeholder="请输入员工号"/>\n            </div>\n            <div class="form-group">\n                <input class="tel" type="text" placeholder="请输入手机号码"/>\n            </div>\n            <div class="form-group">\n                <input class="code" type="text" placeholder="请输入短信验证码"/>\n            </div>\n            <div class="btn-group"></div>\n        </form>'),o=h.query(".tel",i),a=h.query(".code",i),s=h.query(".user",i),r=new u.Button({container:a.parentElement,content:"获取验证码",className:"get-code-btn",onClick:function(){if(v.valid.isTel(o.value)){var e=60;r.isDisabled=!0,r.content=e+"s后重新获取";var t=setInterval(function(){0===--e?(clearInterval(t),r.content="获取验证码",r.isDisabled=!1):r.content=e+"s后重新获取"},1e3);l.BwRule.Ajax.fetch(g.ajaxUrl.smsSend,{data:{mobile:o.value,uuid:n.device.uuid},data2url:!0,type:"POST",headers:{uuid:n.device.uuid}}).catch(function(){clearInterval(t),r.content="获取验证码",r.isDisabled=!1})}else d.Modal.alert("请输入正确的手机号码")}}),c=new u.Button({container:h.query(".btn-group",i),content:"前往解绑",className:"login-submit"});c.wrapper.type="submit",h.append(e,t),h.append(e,i);new d.Modal({container:document.body,header:" ",body:e,position:v.isMb?"full":"",width:"730px",isShow:!0,isOnceDestroy:!0,className:"sms-login"});h.on(i,"submit",function(e){e.preventDefault();var t=o.value,n=a.value,i=s.value;v.isEmpty(i)?d.Modal.alert("请输入员工号"):v.valid.isTel(t)?v.isEmpty(n)?d.Modal.alert("请输入短信验证码"):(c.isLoading=!0,c.isDisabled=!0,c.content="前往中...",l.BwRule.Ajax.fetch(g.ajaxUrl.unBinding,{data:{mobile:t,check_code:n,userid:i},type:"get"}).then(function(e){var t=e.response;new p.UnBinding(t.data)}).finally(function(){c.isLoading=!1,c.isDisabled=!1,c.content="前往解绑"})):d.Modal.alert("请输入正确的手机号码")})},Object.defineProperty(e.prototype,"fingerModal",{get:function(){var e=this;this._fingerModal||(this._fingerModal=new d.Modal({header:"指纹登录",body:h.create('<div data-action="fingerModal"><i class="iconfont icon-zhiwen red block margin-bottom-10" style="font-size:2em;"></i>\n                    <p style="float:left;margin-top:6px;margin-left:10px;max-width:230px;"></p></div>'),onClose:function(){a&&a.destroy&&a.destroy()}}));var o=this._fingerModal,t=h.query("p",o.bodyWrapper),a=new n.NewFinger({autoCache:!1,callFinger:function(e){t.innerHTML="<span>"+e+"</span>"},fingerFinish:function(i){return t.innerHTML="<span>指纹获取成功，正在匹配中...</span>",t.innerHTML="<span>指纹获取成功开始匹配</span><br/>",new Promise(function(){e.ajaxLogin(g.ajaxUrl.loginFinger,{userid:i.userid,fingerprint:i.print,fingertype:i.type,verify:i.verify},function(e){if(e.success){var t=e.data.dataArr,n="";return v.isNotEmpty(t)&&(n=t[t.length-1].fingerData),new Promise(function(e,t){a.addFinger({userid:i.userid,print:n||i.print,type:i.type,verify:i.verify}).finally(function(){o.isShow=!1,e()})})}return new Promise(function(e,t){o.isShow=!1,e()})})})}});return this._fingerModal},enumerable:!0,configurable:!0}),e.prototype.loginByFinger=function(){if(this.validReg()){var e="BlueWhaleShell"in window||"AppShell"in window?{success:!0,msg:"yes"}:{success:!1,msg:"必须在客户端内使用"};e.success?this.fingerModal.isShow=!0:d.Modal.alert(e.msg)}},e.prototype.touchidClick=function(){var n=this;n.validReg()&&f.window.touchid(function(e){var t=JSON.parse(e.detail);t.success?l.BwRule.Ajax.fetch(g.ajaxUrl.passwordEncrypt,{data:{str:n.device.auth_code}}).then(function(e){var t=e.response.body.bodyList[0];n.ajaxLogin(g.ajaxUrl.loginTouchID,{password:t})}):1==t.msg?d.Modal.toast("指纹匹配不正确"):2==t.msg?d.Modal.toast("该设备不支持指纹"):d.Modal.toast(t.msg)})},e.prototype.loginClick=function(){var n=this,e=n.props.saveButton,t=(s.CheckBox,e.checked),i=n.props.password.value,o=n.props.userId.value.replace(/\s+/g,"");v.isEmpty(o)?d.Modal.alert("请填写用户名"):v.isEmpty(i)?d.Modal.alert("请填写密码"):(n.device.isSavePassword=t,l.BwRule.Ajax.fetch(g.ajaxUrl.passwordEncrypt,{data:{str:i}}).then(function(e){var t=e.response.body.bodyList[0];n.ajaxLogin(g.ajaxUrl.loginPassword,{userid:o.toUpperCase(),password:t},function(){return new Promise(function(e){n.device.userid=o.toUpperCase(),n.device.password=i,e()})})}))},e.prototype.ajaxLogin=function(e,n,o){void 0===o&&(o=function(e){return Promise.resolve()});var a=this,t=a.props.loginButton;if(!(t instanceof u.Button?t.wrapper:t).classList.contains("disabled")){a.loginBtnState(1);var s={success:!1,data:null};return new Promise(function(i,t){l.BwRule.Ajax.fetch(e,{type:"post",data:[n],headers:{auth_code:a.device.auth_code,uuid:a.device.uuid}}).then(function(e){var t=e.response;s.success=!0,s.data=t,o(s).then(function(){a.loginBtnState(10);var n=r.User.get();if(t.dataArr.forEach(function(e,t){"are_id"===e.NAME?n.are_id=e.VALUE:"userid"===e.NAME?n.userid=e.VALUE:"USERNAME"===e.NAME?(n.department=e.VALUE,n.username=e.VALUE):"auth_code"===e.NAME&&(a.device.auth_code=e.VALUE)}),"ad"===f.os||"ip"===f.os){var e=t.head.accessToken||"";f.window.opentab(n.userid,e.toString())}else BW.sysPcHistory.setLockKey(n.userid),BW.sysPcHistory.setInitType("1"),f.window.opentab();i()})}).catch(function(e){"function"==typeof o&&o(s).then(function(){a.loginBtnState(0),t(e)})})})}},e.prototype.initEvent=function(e){var t=this,n=this;if(e.regButton){var i=function(){v.isEmpty(n.device.auth_code)?f.window.load(g.url.reg):d.Modal.toast("您的设备已注册")};e.regButton instanceof u.Button?e.regButton.onClick=function(){i()}:h.on(e.regButton,"click",function(){i()})}e.loginButton&&(e.loginButton instanceof u.Button?e.loginButton.onClick=function(){n.loginClick()}:h.on(e.loginButton,"click",function(){n.loginClick()})),e.wxButton&&h.on(e.wxButton,"click",function(){n.wechatChick()}),e.fingerMbBtn&&h.on(e.fingerMbBtn,"click",function(){n.touchidClick()}),e.fingerPcBtn&&h.on(e.fingerPcBtn,"click",function(){n.loginByFinger()}),e.SMSBtn&&e.SMSBtn instanceof u.Button&&(e.SMSBtn.onClick=v.pattern.throttling(function(){t.phoneVerify()},1e3)),e.utButton&&(e.utButton.onClick=v.pattern.throttling(function(){t.unBindling()},1e3)),e.fqaBtn&&(e.fqaBtn.onClick=v.pattern.throttling(function(){new c.FqaModal({})},1e3));var o=0;(v.isMb?h.query(".login-logo>img"):h.query('[data-action="selectServer"]')).addEventListener("click",function(){5===(o+=1)&&(f.window.load(g.url.selectServer),o=0)})},e.prototype.validReg=function(){return!v.isEmpty(this.device.auth_code)||(d.Modal.confirm({msg:"设备未注册",btns:["取消","前往注册"],callback:function(e){!0===e&&f.window.load(g.url.reg)}}),!1)},e.prototype.loginBtnState=function(e){var t=this.props.loginButton,n=t instanceof u.Button?t.wrapper:t,i=f.isMb?n:n.querySelector(".text");switch(e){case 0:n.classList.remove("disabled"),i.innerHTML="登录";break;case 1:n.classList.add("disabled"),f.isMb?i.innerHTML='<span style="width:22px;height:22px;vertical-align:sub" class="mui-spinner"></span> 登录中...':i.innerHTML="登录中...";break;case 10:n.classList.remove("disabled"),i.innerHTML="登录成功"}},e.prototype.loadPassword=function(){var e=this.props.saveButton;this.device.isSavePassword&&(s.CheckBox,e.checked=!0,this.props.userId.value=v.str.toEmpty(this.device.userid),this.props.password.value=v.str.toEmpty(this.device.password))},e.prototype.deviceUpdate=function(){var n=this;if("BlueWhaleShell"in window){var e=BlueWhaleShell.postMessage("getVersion","");l.BwRule.Ajax.fetch(g.ajaxUrl.pcVersion,{data:{getversion:e},silent:!0}).then(function(e){var t=e.response;BlueWhaleShell.postMessage("downloadFile",JSON.stringify(t.data[0]))});var t=BlueWhaleShell.postMessage("getDevice","");v.isEmpty(t)?d.Modal.toast("获取不到设备信息"):this.device.uuid=JSON.parse(t).msg.uuid}else if("ip"===f.os)f.window.getDevice("uuid"),window.addEventListener("getDevice",function(e){var t=JSON.parse(e.detail);t.success?n.device.uuid=t.msg.uuid:d.Modal.toast(t.msg)});else if("ad"===f.os)this.device.uuid=f.window.getDevice("uuid").msg;else if("AppShell"in window&&v.isPc){var i=y.base;i.versionUpdate(g.ajaxUrl.pcVersion,function(){},function(){});var o=i.device;o.success?this.device.uuid=o.data.uuid:d.Modal.toast("获取不到设备信息")}},e}();t.LoginPage=i});