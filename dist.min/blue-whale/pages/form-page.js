define(["require","exports","BasicPage","EditModule","Validate","Modal","BwRule","ButtonAction","Popover"],function(t,e,a,r,n,d,s,u,l){"use strict";var f=G.d,c=BW.sys,o=G.tools;return function(e){function t(a,i){var t=e.call(this,i)||this;t.para=i;var n={fields:[]},o={};return i.fm.fields.forEach(function(t){o[t.name]=t;var e={dom:f.query('[data-name="'+t.name+'"] [data-input-type]',a),field:o[t.name]};n.fields.push(e),(-1<["insert","associate"].indexOf(i.uiType)?e.field.noModify:e.field.noEdit)&&e.dom&&e.dom.classList.add("disabled")}),t.editModule=new r.EditModule(n),t.initData(),t.initEvent(),t}return __extends(t,e),t.prototype.initEvent=function(){var i=this,n=this.para,o=function(){for(var t=0,e=n.fm.subButtons;t<e.length;t++){var a=e[t];if("save"===a.subType)return a}return null}(),t=this.para.dom.querySelector(".btn-group.sub-btn");if(c.isMb)if(1<n.fm.subButtons.length)var e=n.fm.subButtons.map(function(t){return{title:t.title,icon:t.icon}}),a=new l.Popover({items:e,target:t,isBackground:!1,onClick:function(t){a.show=!1,r(t)}});else f.on(t,"click",function(t){t.stopPropagation(),r(0)});else f.on(t,"click","button",function(t){t.stopPropagation(),r(this.dataset.index)});function r(t){var e=n.fm.subButtons[t],a=i.dataGet();switch(e.subType){case"save":e.hintAfterAction=!0,i.save(e,a);break;case"action":o.hintAfterAction=!1,i.save(o,a,function(){u.ButtonAction.get().clickHandle(e,i.dataGet(),function(){},i.url)})}}},t.prototype.dataGet=function(){var i=this.editModule.get();return this.para.fm.fields.forEach(function(t){var e=t.name,a=t.atrrs.defaultValue;t.noEdit&&!o.isEmpty(a)&&(i[e]=a)}),i},t.prototype.initValidate=function(){var i=this,t=this.para.fm.fields;this.validate=new n.Validate,t.forEach(function(t){var e=[];for(var a in t.atrrs)e.push({title:t.caption,name:a,value:t.atrrs[a]});i.validate.add(t.name,e)})},t.prototype.validateFormData=function(t){},t.prototype.save=function(a,t,i){var n=this;u.ButtonAction.get().clickHandle(a,t,function(t){a.buttonType=2;var e=t.data&&t.data[0]?t.data[0]:null;e&&n.editModule.set(e),"function"==typeof i&&i(t)},this.url)},t.prototype.initData=function(){var o=this,r=this.para.fm,t=s.BwRule.getDefaultByFields(r.fields);this.editModule.set(t),r.dataAddr&&s.BwRule.Ajax.fetch(BW.CONF.siteUrl+s.BwRule.reqAddr(r.dataAddr)).then(function(t){var e,a,i,n=t.response.data[0];n?(e=n,a=r.subButtons,i=[],Array.isArray(a)&&a.forEach(function(t){var e=t.actionAddr;e&&Array.isArray(e.varList)&&(i=i.concat(e.varList))}),s.BwRule.addOldField(s.BwRule.getOldField(i),e),n=e,o.editModule.set(n),r.updatefileData&&s.BwRule.Ajax.fetch(s.BwRule.reqAddr(r.updatefileData,n),{silent:!0})):d.Modal.alert("数据为空")})},t}(a.default)});