define(["require","exports","reconnectingWebscoket","Modal","User","Message","Notify"],function(e,t,s,a,o,g,y){"use strict";var m=G.d,w=G.tools,v=BW.sys,h=BW.sysPcHistory,M=BW.CONF;return function(){function e(e){this.props=e;var t=o.User.get(),n=this;t.userid&&("WebSocket"in window?(n.ws=new s(e.wsUrl+"/websocket/"+t.userid+"/single",null,{debug:!0,reconnectInterval:1e3}),n.ws.onopen=function(){},n.ws.onmessage=function(e){return n.onMessage(e)},n.ws.onerror=function(e){},n.ws.onclose=function(e){},document.addEventListener("netchange",function(){0})):a.Modal.toast("您的浏览器不支持websocket."))}return e.prototype.onMessage=function(e){var t=JSON.parse(e.data),n=t.respType,s=this;switch(console.log(t),n){case"notify":var a=t.data.dataMap[0],o=new g.Message({sender:w.str.toEmpty(a.sender),content:w.str.toEmpty(a.content.content),link:w.isEmpty(a.content.link)?"":s.props.mgrPath+a.content.link,time:w.str.toEmpty(a.createDate),num:t.data.dataMap.length});G.localMsg.add(t.data.dataMap);var r=BW.sys.os;if("ip"===r||"ad"===r)"ip"!==r&&BW.sys.ui.notice({msg:JSON.stringify(o.toString())}),w.event.fire("newMsg",JSON.stringify(t.data.dataMap));else if("pc"===r)for(var i=t.data.dataMap,c=function(e){$(".messageList").prepend(s.messageDom(i[e]));var t=M.siteUrl+i[e].content.link;new y.Notify({title:a.sender,content:i[e].content.content,onClick:function(){0<=h.indexOf(t)&&v.window.refresh(t),v.window.open({url:t})}})},d=0;d<i.length;d++)c(d);var l={reqType:t.respType,userId:t.data.userId,notifyIds:t.data.notifyIds};s.ws.send(JSON.stringify(l));break;case"sql":var p=m.query("#sqlMonitorContent",document.body);if(p){for(var u=m.closest(p,".page-container"),f=(d=0,t.data.length);d<f;d++)m.append(p,document.createElement("br")),m.append(p,t.data[d].replace(/\t/g,"    ").replace(/\n/g,""));m.append(p,document.createElement("br")),u.scrollTop=p.scrollHeight}break;case"hint":break;default:console.info("后台返回未知的消息类型.")}},e.prototype.messageDom=function(e){return'<li class="unread" data-url="'+e.content.link+'" data-notifyid="'+e.notifyId+'"><a href="javascript:void(0)" class="unread"><div class="clearfix"><div class="thread-content"><span class="preview">'+e.content.content+'</span><span class="time">'+e.createDate+"</span></div></div></a></li>"},e}()});