define("BugReport",["require","exports","TextInput1","Modal","Button","UploadModule","BwRule"],function(e,t,a,c,r,n,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=G.Component,f=G.d,g=G.tools,v=BW.CONF,l=BW.sys,i=function(i){function e(e,t,a){var r=this,o=new p({success:function(){r.destroy(),t&&l.window.load(location.href)},bugId:e,pageInfo:a});return r=i.call(this,{header:{title:"故障申报"},body:o.wrapper,isShow:!0,width:"730px",className:"bug-report",position:"full"})||this}return __extends(e,i),e}(c.Modal);t.BugReportModal=i;var p=function(i){function e(e){var t,a,o=i.call(this)||this;o.closeImgEvent=(t=function(r){setTimeout(function(){var e=f.closest(r.target,".upload-img"),t=parseInt(e.dataset.index),a=e.dataset.type;f.remove(e),"img"===a?(o.setDataIndex(),0<=t&&o.bugReportItem.picture.splice(t,1)):"video"===a&&o.bugReportItem.video.shift()},10)},{on:function(){return f.on(o.wrapper,"click",".close-ball",t)},off:function(){return f.off(o.wrapper,"click",".close-ball",t)}}),o.playVideoEvent=(a=function(e){},{on:function(){return f.on(o.wrapper,"click",".app-shipin",a)},off:function(){return f.off(o.wrapper,"click",".app-shipin",a)}}),o.success=e.success,o.isUpload=!0;var r=g.isEmpty(e.bugId)?-1:e.bugId;return o.pageInfo=e.pageInfo,0<=r&&m.BwRule.Ajax.fetch(v.ajaxUrl.bugDetail+"?bugid="+r).then(function(e){var t=e.response;0===t.errorCode&&(o.bugData=t.data)}),o.closeImgEvent.on(),o.playVideoEvent.on(),o}return __extends(e,i),Object.defineProperty(e.prototype,"isUpload",{get:function(){return this._isUpload},set:function(e){this._isUpload=e},enumerable:!0,configurable:!0}),e.prototype.wrapperInit=function(){var d=this,e=h("form",{className:"bug-report-form"},h("div",{className:"form-group"},h("div",{className:"form-text","data-name":"title"}),h("div",{className:"form-textarea","data-name":"detail"}),h("div",{className:"form-img","data-name":"uploader"},h("div",{className:"uploader-wrapper"})),h("div",{className:"msg"},"温馨提示: 最多可上传5张图片和1个短视频")),h("div",{className:"submit","data-name":"submit"}));return this.formEle={title:null,detail:null,upload:null,submit:null},f.queryAll("[data-name]",e).forEach(function(o){switch(o.dataset.name){case"title":var e=new a.TextInput1({placeholder:"添加标题",type:"text",labelWidth:0,container:o});o.appendChild(h("span",{className:"title-num"},"30")),d.formEle.title=e;var i="";f.on(e.wrapper,"input","input",function(e){var t=e.target,a=g.str.utf8Len(t.value);if(60<a)t.value=i,c.Modal.toast("最多可输入30个字");else{i=t.value;var r=Math.floor((60-a)/2);f.query(".title-num",o).innerHTML=r<0?"0":r.toString()}});break;case"detail":d.formEle.detail=new a.TextAreaInput({className:"report-textarea",container:o,placeholder:"请描述具体故障问题"});break;case"uploader":var l=h("div",{className:"addImage"},h("div",{className:"upload"})),t=f.query(".uploader-wrapper",o),p="",u="";d.formEle.upload=l,t.appendChild(l);var s=new n.default({uploadUrl:v.ajaxUrl.fileUpload,nameField:"FILE_ID",onComplete:function(e,t){var a=e.data.blobField.value;if("img"===p)for(var r=t.name,o=d.bugReportItem.picture,i=0,n=o.length;i<n;i++){var l=o[i];if(g.isEmpty(l.fileId)&&l.fileName===r){l.fileId=a;break}}else d.bugReportItem.video[0].fileId=a},onError:function(e){if("img"===p)for(var t=e.name,a=d.bugReportItem.picture,r=0,o=a.length;r<o;r++){var i=a[r];if(i.fileName===t&&g.isEmpty(i.fileId)){var n=f.query('.upload-img[data-index="'+r+'"]',d.wrapper);d.addErrorMark(n),a.splice(r,1);break}}else{d.bugReportItem.video=[];var l=f.query(".upload-img[data-type=video]",d.wrapper);d.addErrorMark(l,!1),u=""}},container:f.query(".upload",l),text:"+"});s.com.on("uploadFinished",function(){d.isUpload=!0}),s.com.on("fileQueued",function(e){if("image"===e.type.split("/")[0]){if(!(d.bugReportItem.picture.length<=4))return c.Modal.alert("最多可添加5张图片和1个视频"),!1;for(var t=d.bugReportItem.picture,a=e.name,r=0,o=t.length;r<o;r++){if(t[r].fileName===a)return c.Modal.alert("已经添加过该图片"),!1}d.isUpload=!1;var i={fileId:"",fileName:a};d.bugReportItem.picture.push(i);var n=window.URL.createObjectURL(e.source.source);f.before(l,d.addImg(n,"img")),f.query(".form-img",d.wrapper).scrollLeft=f.query(".form-img",d.wrapper).scrollLeft+100,p="img",s.com.upload()}else if("video"===e.type.split("/")[0]){if(g.isNotEmpty(u))return e.name===u?c.Modal.alert("已经添加过该视频了"):c.Modal.alert("最多可添加一个视频"),!1;d.isUpload=!1;i={fileId:"",fileName:e.name};d.bugReportItem.video.push(i),u=e.name;n=window.URL.createObjectURL(e.source.source);f.before(l,d.addImg(n,"video")),p="video",s.com.upload()}});break;case"speak":new r.Button({content:"按住说话",icon:"app-maikefeng",iconPre:"appcommon",container:o,onClick:function(){},className:"speak-btn"}),new r.Button({content:"录制视频",icon:"app-shipin",iconPre:"appcommon",container:o,onClick:function(){}});break;case"submit":d.formEle.submit=new r.Button({content:"提交",container:o,className:"submit-btn",onClick:function(){var e=d.bugReportItem.info,t=d.formEle;e.title=t.title.value,e.message=t.detail.value;var a=d.pageInfo;if(g.isNotEmpty(a)&&(e.url=a.url,e.param=a.param,e.reqType=a.reqType,e.errMsg=a.errMsg),g.isNotEmpty(e.title))if(d.isUpload)if(g.isNotEmpty(d.bugData)){var r=g.obj.merge(d.bugReportItem);r.info.bugId=d.bugData.info.bugId,m.BwRule.Ajax.fetch(v.ajaxUrl.bugReport,{type:"POST",data:r}).then(function(e){0===e.response.errorCode&&c.Modal.toast("修改成功"),d.success()})}else m.BwRule.Ajax.fetch(v.ajaxUrl.bugReport,{type:"POST",data:d.bugReportItem}).then(function(e){0===e.response.errorCode&&c.Modal.toast("提交故障成功"),d.success()});else c.Modal.alert("图片或视频正在上传，请稍候...");else c.Modal.alert("标题不能为空!")}})}}),e},e.prototype.setDataIndex=function(){var e=f.queryAll('.upload-img[data-type="img"]',this.wrapper);e=e.filter(function(e){return"-1"!==e.dataset.index}),g.isNotEmpty(e)&&e.forEach(function(e,t){e.dataset.index=t.toString()})},Object.defineProperty(e.prototype,"bugData",{get:function(){return this._bugData},set:function(e){var a=this;this._bugData=e;var t=this.bugReportItem;t.info.title=e.info.title,t.info.message=e.info.message,t.picture=e.picture,t.video=e.video,t.voice=e.voice,this.formEle.title.value=e.info.title,this.formEle.detail.value=e.info.message;var r=g.str.utf8Len(e.info.title),o=Math.floor((60-r)/2);f.query(".title-num",this.wrapper).innerHTML=o<0?"0":o.toString();var i=e.picture,n=this.formEle.upload;g.isNotEmpty(i)&&i.forEach(function(e){var t=a.getFileUrl(e.fileId);f.before(n,a.addImg(t,"img"))});var l=e.video;g.isNotEmpty(l)&&l.forEach(function(e){var t=a.getFileUrl(e.fileId);f.before(n,a.addImg(t,"video"))})},enumerable:!0,configurable:!0}),e.prototype.addImg=function(e,t){var a=f.queryAll(".upload-img",this.wrapper);0<a.length&&(a=a.filter(function(e){return"-1"!==e.dataset.index}));var r=a.length;return"img"===t?h("div",{className:"upload-img","data-index":r,"data-type":"img"},h("img",{src:e,alt:"故障截图"}),h("div",{className:"close-ball"},"×")):h("div",{className:"upload-img","data-index":"0","data-type":"video"},h("video",{src:e}),h("i",{className:"appcommon app-shipin"}),h("div",{className:"close-ball"},"×"))},e.prototype.addErrorMark=function(e,t){void 0===t&&(t=!0),t?e.dataset.index="-1":e.dataset.type="video-error",e.appendChild(h("div",{className:"bug-error"},h("i",{className:"appcommon app-shibai"}),h("br",null),"传输失败")),t&&this.setDataIndex()},Object.defineProperty(e.prototype,"bugReportItem",{get:function(){if(!this._bugReportItem){var e=JSON.parse(localStorage.getItem("deviceInfo"));this._bugReportItem={info:{title:"",uuid:e.uuid,message:"",url:"",param:"",reqType:"",errMsg:""},picture:[],voice:[],video:[]}}return this._bugReportItem},enumerable:!0,configurable:!0}),e.prototype.getFileUrl=function(e){return g.url.addObj(v.ajaxUrl.fileDownload,{md5_field:"FILE_ID",file_id:e,down:"allow"})},e.prototype.destroy=function(){i.prototype.destroy.call(this),this.playVideoEvent.off(),this.closeImgEvent.off()},e}(o);t.BugReport=p});