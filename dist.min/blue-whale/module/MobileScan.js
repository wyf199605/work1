define("MobileScan",["require","exports","Button","ShellAction","Modal"],function(n,e,i,c,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=G.tools,u=G.d,p=G.Shell,t=function(){function n(t){var c=this;this.rfidFlag=!0,this.scanFlag=!0,this.rfidArr=[],this.scanArr=[],this.p=t;var r=p.inventory.can2dScan,a=t.scannableType||0,o=new i.Button({type:"link",content:0===a||2===a?r?"按下扫码枪查询":"扫码查询":"RFID扫码",size:"large",container:t.container,className:"mobile-scan",icon:r?"":"richscan_icon",onClick:0===a&&r?null:function(){switch(a){case 1:c.rfidFlag?c.startEpc(o):c.stopEpc(o,t);break;case 2:if(!r)return void l.Modal.alert("该操作只支持扫码枪");c.scanFlag?(o.wrapper.innerHTML="结束扫码",c.scanFlag=!1,p.inventory.scan2dOn(function(n){var e=n&&n.data;n&&n.success&&"openSuponScan"!==e&&!c.scanArr.includes(e)&&c.scanArr.push(e)})):(o.wrapper.innerHTML="按下扫码枪查询",c.scanFlag=!0,s.isFunction(t&&t.callback)&&t.callback({selection:c.scanArr.join(",")}),c.scanArr=[]);break;default:var n=t.cols;if(Array.isArray(n)){var e="";n.forEach(function(n){n.name===t.scannableField&&(e=n.caption)}),l.Modal.toast("只能扫描"+e),setTimeout(function(){c.open(t)},500)}else c.open(t)}o.wrapper.blur()}});0===a&&r&&this.scanOpen().then(function(n){s.isFunction(t.callback)&&n.success&&"openSuponScan"!==n.data&&t.callback({mobilescan:n.data})}),u.on(o.wrapper,"touchstart",function(n){var e=n.touches[0],t=o.wrapper,c=e.clientX-t.offsetLeft,r=e.clientY-t.offsetTop,a=function(n){n.preventDefault();var e=n.touches[0];t.style.left=e.clientX-c+"px",t.style.top=e.clientY-r+"px"},i=function(){u.off(document,"touchmove",a),u.off(document,"touchend",i)};u.on(document,"touchmove",a),u.on(document,"touchend",i)})}return n.prototype.scanOpen=function(){return new Promise(function(e,n){p.inventory.openScan(function(n){e(n)})})},n.prototype.open=function(t){c.ShellAction.get().device().scan({callback:function(n){var e=JSON.parse(n.detail).data;"function"==typeof t.callback&&t.callback({mobilescan:e})}})},n.prototype.startEpc=function(t){var c=this;this.rfidArr=[],this.rfidFlag=!1;var r=1e3*(this.p.scannableTime||0);t.wrapper.innerHTML="结束扫描",p.inventory.clearEpc(null,function(n){if(n.success){var e=function(n){n.success?(0!==r&&(c.rfidArr=[]),Array.isArray(n.data)&&n.data.forEach(function(n){c.rfidArr.push(n.epc)}),0===r?t.wrapper.innerHTML="结束扫描("+c.rfidArr.length+")":c.p.callback({selection:c.rfidArr.join(",")}).then(function(){c.rfidFlag||p.inventory.returnEpcbyTime(null,r,!0,e)}).catch(function(){c.rfidFlag||p.inventory.returnEpcbyTime(null,r,!0,e)})):l.Modal.alert(n.msg)};p.inventory.returnEpcbyTime(null,r,!0,e)}})},n.prototype.stopEpc=function(n,e){var t=this.p.scannableTime||0;p.inventory.returnEpcbyTime(null,t,!1,function(n){}),0===t&&e.callback({selection:this.rfidArr.join(",")}),n.wrapper.innerHTML="RFID扫码",this.rfidFlag=!0},n}();e.MobileScan=t});