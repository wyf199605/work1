define("NewStatisticBasic",["require","exports","BwRule","SelectBox","statistic","Modal","Button","InputBox","NewStatisticBase"],function(t,e,m,s,v,i,o,n,a){"use strict";var l,c=G.d,d=BW.sys;return(l=function(a){function r(t){var e=a.call(this)||this;return e.para=t,e.modal=null,e.coms={},e.statisticsContent=[],e.statisticsField=[],e.statisticsRange=[],e.groupingField=[],e.initModal(),e.getSelectData(),e.replaceDataName(),e}return __extends(r,a),r.prototype.getModal=function(){return this.modal},r.prototype.getSelectData=function(){var t,e=[],a=[],s=this.para.getVisibleCol();for(t=0;t<this.para.cols.length;t++)this.para.cols[t].isNumber&&-1<s.indexOf(this.para.cols[t].name)&&e.push({value:this.para.cols[t].name,text:this.para.cols[t].title});for(t=0;t<this.para.cols.length;t++)-1<s.indexOf(this.para.cols[t].name)&&a.push({value:this.para.cols[t].name,text:this.para.cols[t].title});this.groupingField=a,this.statisticsField=e,this.statisticsContent=[{value:"sum",text:"合计值"},{value:"avg",text:"平均值"},{value:"max",text:"最大值"},{value:"min",text:"最小值"},{value:"stDev",text:"标准差"},{value:"nullCount",text:"空值数"},{value:"percent",text:"百分比"},{value:"groupPercent",text:"组内百分比"}],this.statisticsRange=[{value:"0",text:"全部数据"},{value:"1",text:"选定数据"}]},r.prototype.initDataName=function(t,e){var o=this;switch(t){case"statisticsContent":this.coms.statisticsContent=new s.SelectBox({container:e,select:{multi:!0,callback:function(t){var a=o.coms.statisticsContent;6===t&&(a.unSet([7]),!function(t){for(var e=0;e<a.get().length;e++)if(a.get()[e]===t)return!0;return!1}(6)?a.setDisabled([7]):a.unsetDisabled([7]))}},data:this.statisticsContent});break;case"statisticsField":0<this.statisticsField.length?this.coms.statisticsField=new s.SelectBox({container:e,select:{multi:!0},data:this.statisticsField}):e.innerHTML="无可统计的字段";break;case"statisticsRange":this.coms.statisticsRange=new s.SelectBox({container:e,select:{multi:!1},data:this.statisticsRange});break;case"groupingField":0<this.statisticsField.length?this.coms.groupingField=new s.SelectBox({container:e,select:{multi:!1,isRadioNotchecked:!0,callback:function(e){function t(){for(var t=0;t<o.statisticsField.length;t++)if(o.statisticsField[t].value===o.groupingField[e].value)return t}var a=o.coms.statisticsField,s=o.coms.statisticsContent,i=o.coms.groupingField;0<=o.lastIndex&&a.unsetDisabled([o.lastIndex]),0<=t()&&(a.unSet([t()]),a.setDisabled([t()]),o.lastIndex=t()),s.unSet([1,2,3,4,5]),0<i.get().length?(s.setDisabled([1,2,3,4,5]),s.unsetDisabled([6])):(s.unSet([1,2,3,4,5,6,7]),s.unsetDisabled([1,2,3,4,5]),s.setDisabled([6]),0<=o.lastIndex&&a.unsetDisabled([o.lastIndex]))}},data:this.groupingField}):e.innerHTML="无可统计的字段"}},r.prototype.initModal=function(){var t,e,l=this,a=function(){if(0===l.statisticsField.length)return!1;var t,e=[],a=0,s=[],i=l.coms.statisticsContent.get(),o=l.coms.statisticsField.get(),n="";for(a=0;a<i.length;a++)7===i[a]&&i.splice(a,1);for(0<l.coms.groupingField.get().length&&(n=l.groupingField[l.coms.groupingField.get()[0]].value),a=0;a<i.length;a++)e.push({title:r.mathMethodCn[l.statisticsContent[i[a]].value],method:v.Statistic.math[l.statisticsContent[i[a]].value]});for(a=0;a<o.length;a++)s.push(l.statisticsField[l.coms.statisticsField.get()[a]].value);return t=l.colStatistic(s,e,n),l.tableRender(t,l.para.container),!1};d.isMb?(this.modal=new i.Modal({header:"统计",position:"full",isOnceDestroy:!0}),this.modal.modalHeader.rightPanel=(t=new n.InputBox,e=new o.Button({key:"okBtn",content:"确认",type:"primary",onClick:a}),t.addItem(e),t),this.modal.bodyWrapper.setAttribute("style","height:calc(100vh - 44px);"),this.modal.bodyWrapper.parentElement.classList.add("statistic")):this.modal=new i.Modal({header:"统计",className:"statistic",width:"560px",container:this.para.container,isBackground:!1,footer:{},isOnceDestroy:!0}),this.modal.onOk=a},r.prototype.replaceDataName=function(){var e=this;this.body=this.modal.bodyWrapper;var t=r.getDom();this.body.innerHTML=t,c.queryAll("[data-name]",this.body).forEach(function(t){e.initDataName(t.dataset.name,t)}),this.coms.statisticsContent.setDisabled([6,7])},r.prototype.colName2index=function(t){for(var e=0;e<this.para.cols.length;e++)if(this.para.cols[e].name===t)return e},r.prototype.colStatistic=function(i,o,e){var a,s,n=this,l=i.map(function(t){return n.para.cols[n.colName2index(t)]}),r=i.map(function(t){return n.para.colDataGet(t)}),c={},t={cols:null,data:null};if(e){var d=n.para.cols[n.colName2index(e)];n.para.colDataGet(e).forEach(function(t,a){var s=i.map(function(t,e){return r[e][a]});t in c||(c[t]=[]),c[t][0]?c[t].forEach(function(t,e){t.push(s[e])}):c[t]=s.map(function(t){return[t]})});var h=[],u=function(t){var e=0;c[t].map(function(t){h[e]||(h[e]=0),h[e]=h[e]+v.Statistic.math.sum(t),e++})};for(var p in c)u(p);var f=function(t){if(!c.hasOwnProperty(t))return"continue";var a=-1;c[t]=c[t].map(function(e){return o.map(function(t){return"百分比"!==t.title?t.method(e):(a++,v.Statistic.math.percent(e,h[a]))})})};for(var p in c)f(p);t.cols=[d].concat((s=[],l.forEach(function(a){o.forEach(function(t){var e=G.tools.obj.copy(a);e.title=e.title+t.title,e.name=e.name+t.title,e.name.match("百分比")&&(e.dataType=m.BwRule.DT_PERCENT),s.push(e)})}),s)),t.data=(a=[],Object.keys(c).forEach(function(t){var i={};i[e]=t,c[t].forEach(function(a,s){o.forEach(function(t,e){i[l[s].name+t.title]=a[e]})}),a.push(i)}),a)}else t.cols=[{title:"统计",name:"_method"}].concat(l),t.data=o.map(function(a){var s={_method:a.title};return r.forEach(function(t,e){s[i[e]]=a.method(t.slice(0))}),s});return t},r.getDom=function(){return'<div class="row"><div class="col-xs-5"><fieldset class="col-xs-12"><legend>内容</legend><div class="statisticsContent"><div data-name="statisticsContent"></div></div></fieldset><fieldset class="col-xs-12"><legend>范围</legend><div class="statisticsRange"><div data-name="statisticsRange"></div></div></fieldset></div><fieldset class="col-xs-3"><legend>统计字段</legend><div class="statisticsField"><div data-name="statisticsField"></div></div></fieldset><fieldset class="col-xs-3 groupingField_grouping"><legend>分组字段</legend><div class="groupingField"><div data-name="groupingField"></div></div></fieldset></div>'},r}(a.NewStatisticBase)).mathMethodCn={sum:"合计值",avg:"平均值",max:"最大值",min:"最小值",stDev:"标准差",nullCount:"空值数",percent:"百分比",groupPercent:"组内百分比"},l}),define("NewCrossTabBasic",["require","exports","Button","Modal","SelectBox","statistic","InputBox","NewStatisticBase"],function(t,e,i,c,o,d,n,a){"use strict";var l=G.d,h=BW.sys;return function(a){function s(t){var e=a.call(this)||this;return e.conf=t,e.modal=null,e.coms={},e.statisticRow=[],e.statisticCol=[],e.statisticVal=[],e.initModal(),e.getSelectData(),e.replaceDataName(),e}return __extends(s,a),s.prototype.getModal=function(){return this.modal},s.prototype.getSelectData=function(){var t,e=[],a=[],s=this.conf.getVisibleCol();for(t=0;t<this.conf.cols.length;t++)this.conf.cols[t].isNumber&&-1<s.indexOf(this.conf.cols[t].name)&&a.push({value:this.conf.cols[t].name,text:this.conf.cols[t].title});for(t=0;t<this.conf.cols.length;t++)-1<s.indexOf(this.conf.cols[t].name)&&e.push({value:this.conf.cols[t].name,text:this.conf.cols[t].title});this.statisticRow=e,this.statisticCol=e,this.statisticVal=a},s.prototype.initDataName=function(t,e){var a=this;switch(t){case"row":this.coms.row=new o.SelectBox({container:e,select:{multi:!0,callback:function(t){a.cancleSame("row",t)}},data:this.statisticRow});break;case"col":this.coms.col=new o.SelectBox({container:e,select:{multi:!0,callback:function(t){a.cancleSame("col",t)}},data:this.statisticCol});break;case"val":this.coms.val=new o.SelectBox({container:e,select:{multi:!0,callback:function(t){a.cancleSame("val",t)}},data:this.statisticVal});break;case"statistic_select":this.coms.statistic_select=new o.SelectBox({container:e,select:{multi:!1,callback:function(t){}},data:[{value:0,text:"基于全部数据"},{value:1,text:"基于选定数据"}]});break;case"statistic_sum":this.coms.statistic_sum=new o.SelectBox({container:e,select:{multi:!0,callback:function(t){}},data:[{value:0,text:"生成合计值"}]});break;case"statistic_fixed":this.coms.statistic_fixed=new o.SelectBox({container:e,select:{multi:!0,callback:function(t){}},data:[{value:0,text:"是否锁列"}]}),this.coms.statistic_fixed.setAll()}},s.prototype.initModal=function(){var t,e,l=this,r=this,a=new n.InputBox,s=(new i.Button({key:"savaBtn",content:"设为默认值",type:"primary",onClick:function(){r.modal.isShow=!1}}),function(){var t,e=r.coms.row,a=r.coms.col,s=r.coms.val,i=[],o=[],n=[];if(0===e.get().length||0===a.get().length||0===s.get().length)return c.Modal.alert("行,列,值不允许为空"),!1;for(t=0;t<e.get().length;t++)i.push(r.statisticRow[e.get()[t]].value);for(t=0;t<a.get().length;t++)o.push(r.statisticCol[a.get()[t]].value);for(t=0;t<s.get().length;t++)n.push(r.statisticVal[s.get()[t]].value);if(1!==r.coms.statistic_select.get()[0]||0!==r.conf.selectedData().length)return d.Statistic.crossTable.init({row:i,col:o,val:n,cols:r.conf.cols,data:0===r.coms.statistic_select.get()[0]?r.conf.allData():r.conf.selectedData(),isFixed:1===l.coms.statistic_fixed.get().length}).then(function(t){r.tableRender(t,r.conf.container,!0)}).catch(function(t){c.Modal.alert(t)}),!1;c.Modal.alert("数据为空，无法统计")});h.isMb?(this.modal=new c.Modal({position:"full",isOnceDestroy:!0,header:"交叉制表"}),this.modal.modalHeader.rightPanel=(t=new n.InputBox,e=new i.Button({key:"okBtn",content:"确认",type:"primary",onClick:s}),t.addItem(e),t),this.modal.bodyWrapper.setAttribute("style","height:calc(100vh - 44px);"),this.modal.bodyWrapper.parentElement.classList.add("crossTab")):this.modal=new c.Modal({className:"crossTab",width:"560px",container:this.conf.container,header:"交叉制表",isBackground:!1,footer:{leftPanel:a},isOnceDestroy:!0}),this.modal.onOk=s},s.prototype.replaceDataName=function(){var e=this;this.body=this.modal.bodyWrapper;var t=s.getDom();this.body.innerHTML=t,l.queryAll("[data-name]",this.body).forEach(function(t){e.initDataName(t.dataset.name,t)})},s.prototype.cancleSame=function(t,e){var a,s=this.coms.row,i=this.coms.col,o=this.coms.val,n=G.tools.obj.merge(!0,[],s.get()),l=G.tools.obj.merge(!0,[],i.get()),r=G.tools.obj.merge(!0,[],o.get());if(n=G.tools.obj.toArr(n),l=G.tools.obj.toArr(l),r=G.tools.obj.toArr(r),"row"===t){for(i.set([]),o.set([]),a=0;a<l.length;a++)this.statisticRow[e].value===this.statisticCol[l[a]].value&&l.splice(a,1);for(a=0;a<r.length;a++)this.statisticRow[e].value===this.statisticVal[r[a]].value&&r.splice(a,1);i.set(l),o.set(r)}else if("col"===t){for(s.set([]),o.set([]),a=0;a<n.length;a++)this.statisticCol[e].value===this.statisticRow[n[a]].value&&n.splice(a,1);for(a=0;a<r.length;a++)this.statisticCol[e].value===this.statisticVal[r[a]].value&&r.splice(a,1);s.set(n),o.set(r)}else{for(s.set([]),i.set([]),a=0;a<n.length;a++)this.statisticVal[e].value===this.statisticRow[n[a]].value&&n.splice(a,1);for(a=0;a<l.length;a++)this.statisticVal[e].value===this.statisticCol[l[a]].value&&l.splice(a,1);s.set(n),i.set(l)}},s.getDom=function(){return'<div class="row"><div class="col-xs-4"><fieldset class="col-xs-12"><legend>行</legend><div class="statistic_row"><div data-name="row"></div></div></legend></fieldset></div><div class="col-xs-4"><fieldset class="col-xs-12"><legend>列</legend><div class="statistic_col"><div data-name="col"></div></div></legend></fieldset></div><div class="col-xs-4"><fieldset class="col-xs-12"><legend>值</legend><div class="statistic_val"><div data-name="val"></div></div></legend></fieldset></div></div><div class="row"><div class="col-xs-8"><div data-name="statistic_select" class="statistic_select"></div></div><div class="col-xs-4"><div data-name="statistic_fixed" class="statistic_sum"></div></div></div>'},s}(a.NewStatisticBase)}),define("NewAnalysisBasic",["require","exports","SelectBox","statistic","TextInput","Modal","Button","InputBox","NewStatisticBase"],function(t,e,s,r,i,c,d,h,a){"use strict";var n=G.d,u=G.tools;return function(a){function l(t){var e=a.call(this)||this;return e.conf=t,e.modal=null,e.coms={},e.statisticClassify=[],e.statisticValue=[],e.initModal(),e.getSelectData(),e.replaceDataName(),e}return __extends(l,a),l.prototype.getModal=function(){return this.modal},l.prototype.getSelectData=function(){var t,e=[],a=[],s=this.conf.getVisibleCol();for(t=0;t<this.conf.cols.length;t++)this.conf.cols[t].isNumber&&-1<s.indexOf(this.conf.cols[t].name)&&a.push({value:this.conf.cols[t].name,text:this.conf.cols[t].title});for(t=0;t<this.conf.cols.length;t++)-1<s.indexOf(this.conf.cols[t].name)&&e.push({value:this.conf.cols[t].name,text:this.conf.cols[t].title});this.statisticClassify=e,this.statisticValue=a},l.prototype.initModal=function(){var t=this,s=this,e=new h.InputBox,a=new d.Button({content:"设为默认值",key:"savaBtn",type:"primary",onClick:function(){t.modal.isShow=!1}});e.addItem(a);var i,o,n=function(){s.coms.proport;var t,e,a=s.coms.statistic_select;s.coms.statistic_showClass;return(e=s.getUserInput())&&1===a.get()[0]&&(e.data=s.conf.selectedData()),s.checkIsOk(e)&&(t=(new r.Statistic).abc(e),s.tableRender(t,s.conf.container)),!1};u.isMb?(this.modal=new c.Modal({position:"full",isOnceDestroy:!0,body:G.d.create("<div>"+l.getDom()+"</div>"),header:"abc分析"}),this.modal.modalHeader.rightPanel=(i=new h.InputBox,o=new d.Button({key:"okBtn",content:"确认",type:"primary",onClick:n}),i.addItem(o),i),this.modal.bodyWrapper.setAttribute("style","height:calc(100vh - 44px);"),this.modal.bodyWrapper.parentElement.classList.add("analysis")):this.modal=new c.Modal({className:"analysis",container:this.conf.container,header:"ABC分析",body:G.d.create("<div>"+l.getDom()+"</div>"),isBackground:!1,footer:{leftPanel:e},isOnceDestroy:!0}),this.modal.onOk=n},l.prototype.initDataName=function(t,e){switch(t){case"classify":this.coms.classify=new s.SelectBox({container:e,select:{multi:!1,callback:function(t){}},data:this.statisticClassify});break;case"value":this.coms.value=new s.SelectBox({container:e,select:{multi:!1,callback:function(t){}},data:this.statisticValue});break;case"proport":this.coms.proport=new s.SelectBox({container:e,select:{multi:!1,callback:function(t){}},data:[{value:0,text:"自动查找"},{value:1,text:"手工设置"}]});break;case"aClass":this.coms.aClass=new i.TextInput({container:e});break;case"bClass":this.coms.bClass=new i.TextInput({container:e});break;case"statistic_select":this.coms.statistic_select=new s.SelectBox({container:e,select:{multi:!1,callback:function(t){}},data:[{value:0,text:"基于全部数据"},{value:1,text:"基于选定数据"}]})}},l.prototype.checkIsOk=function(t){void 0===t&&(t={});var e=this.coms.aClass,a=this.coms.bClass;return isNaN(parseInt(e.get()))?(c.Modal.alert("A类不允许为空或字符串"),!1):99<parseInt(e.get())||parseInt(e.get())<0?(c.Modal.alert("A类输入范围为0-99"),!1):isNaN(parseInt(a.get()))?(c.Modal.alert("B类不允许为空或字符串"),!1):99<parseInt(a.get())||parseInt(a.get())<0?(c.Modal.alert("B类输入范围为0-99"),!1):parseInt(a.get())<parseInt(e.get())?(c.Modal.alert("B类范围不可小于A类"),!1):0===t.data.length?(c.Modal.alert("数据为空，无法统计"),!1):!(t.a>t.b)||(c.Modal.alert("A类不可高于B类"),!1)},l.prototype.replaceDataName=function(){var e=this;this.body=this.modal.bodyWrapper;var t=this;n.queryAll("[data-name]",this.body).forEach(function(t){e.initDataName(t.dataset.name,t)});var a=this.coms.aClass,s=this.coms.bClass,i=a.wrapper.firstChild,o=s.wrapper.firstChild;i.value="65",o.value="85",a.on("blur",function(){""!==a.get()&&(n.query(".bFirst",t.body).innerText=a.get())}),s.on("blur",function(){""!==s.get()&&(n.query(".cFirst",t.body).innerText=s.get())})},l.prototype.getUserInput=function(){var t=this.coms.classify,e=this.coms.value,a=this.coms.bClass,s=this.coms.aClass;return!!(0<e.get().length&&s.get()&&a.get())&&{classify:this.statisticClassify[t.get()[0]].value,val:this.statisticValue[e.get()[0]].value,a:parseInt(s.get()),b:parseInt(a.get()),cols:this.conf.cols,data:this.conf.allData()}},l.getDom=function(){return'<div class="row"><div class="col-xs-4"><fieldset class="col-xs-12"><legend>分类</legend><div class="statistic_classify"><div data-name="classify"></div></div></legend></fieldset></div><div class="col-xs-4"><fieldset class="col-xs-12"><legend>值</legend><div class="statistic_value"><div data-name="value"></div></div></legend></fieldset></div><div class="col-xs-4"><fieldset class="col-xs-12"><legend>占比段</legend><div class="statistic_proport"><div data-name="proport"></div><div class = "aClass" data-name="aClass"><span>A类:<span>0%-</span></span></div><div class = "bClass" data-name="bClass"><span>B类:<span><span class="bFirst">65</span>%-</span></span></div><div class = "cClass"><span>C类:<span><span class="cFirst">85</span>%-100%</span></span></div></div></legend></fieldset></div></div><div class="row"><div class="col-xs-8"><div data-name="statistic_select" class="statistic_select"></div></div></div>'},l}(a.NewStatisticBase)}),define("NewChartBasic",["require","exports","echarts","Modal","SelectBox","SelectInput","Echart","Button","InputBox","BwRule","BwTableModule"],function(m,t,o,v,i,n,p,a,s,g,c){"use strict";var e,y=G.tools,x=G.d,b=G.d,w=BW.sys;return(e=function(){function u(t){var h,s;this.para=t,this.coms={},this.chartType=[],this.chartRow=[],this.chartCol=[],this.isPie=!1,this.isLarge=!0,this.hasLinkCol={},this.getCols=function(t){for(var e=this.para.cols,a=0,s=e.length;a<s;a++)if(e[a].title===t)return e[a]},this.generateChartOption=(h=this,(s=[])[0]=function(t){var e,a=[],s=-1,i=[],o=[],n=w.isMb?8:12;for(var l in t.ySeries)if(!y.isEmpty(t.ySeries[l])){for(var r in s++,t.ySeries[l])a.push({name:r,type:"line",yAxisIndex:s,symbolSize:12,data:t.ySeries[l][r]});i.push({name:u.yType[l],type:"时间"===u.yType[l]?"time":"value",axisLabel:{fontSize:n}})}(e=new p.Echart).legend=w.isMb?{type:"scroll",bottom:"0px",left:0,data:t.legend}:{type:"scroll",orient:"vertical",right:"3%",top:20,bottom:0,data:t.legend},e.xAxis={type:"category",boundaryGap:!1,data:t.xData,triggerEvent:!0};var c=this.para.getTablePara().isReplaceTable;(w.isMb&&!c||!w.isMb)&&(e.dataZoom=[{type:"inside",show:!0,xAxisIndex:[0]},{type:"inside",show:!0,yAxisIndex:[0]}]),w.isMb||(e.tooltip={trigger:"axis",show:!0,axisPointer:{type:"cross",crossStyle:{color:"#999"}},formatter:function(t){for(var e,a=t[0].name+"<br/>",s=0,i=t.length;s<i;s++)e=g.BwRule.formatText(t[s].value,h.getCols(t[s].seriesName),!1),a+=t[s].seriesName+"："+e+"<br/>";return a}}),e.yAxis=i,e.series=a;for(var d=0;d<t.legend.length;d++)o.push(u.getRandomCol());return e.color=o,e.getOption()},s[1]=function(t){var e,a=[],s=-1,i=[],o=[],n=w.isMb?8:12;for(var l in t.ySeries)if(!y.isEmpty(t.ySeries[l])){for(var r in s++,t.ySeries[l])a.push({name:r,type:"bar",yAxisIndex:s,data:t.ySeries[l][r]});i.push({name:u.yType[l],type:"时间"===u.yType[l]?"time":"value",axisLabel:{fontSize:n}})}(e=new p.Echart).legend=w.isMb?{type:"scroll",bottom:"0px",left:0,data:t.legend}:{type:"scroll",orient:"vertical",right:"3%",top:20,bottom:0,data:t.legend},e.xAxis={type:"category",data:t.xData,triggerEvent:!0,axisPointer:{type:"shadow"}};for(var c=0;c<t.legend.length;c++)o.push(u.getRandomCol());e.color=o,e.yAxis=i,e.series=a;var d=-1<["web","webdrill","drill"].indexOf(h.para.getTablePara().uiType);return(w.isMb&&!d||!w.isMb)&&(e.dataZoom=[{type:"inside",show:!0,xAxisIndex:[0]},{type:"inside",show:!0,yAxisIndex:[0]}]),w.isMb||(e.tooltip={trigger:"axis",show:!0,axisPointer:{type:"cross",crossStyle:{color:"#999"}},formatter:function(t){for(var e,a=t[0].name+"<br/>",s=0,i=t.length;s<i;s++)e=g.BwRule.formatText(t[s].value,h.getCols(t[s].seriesName),!1),a+=t[s].seriesName+"："+e+"<br/>";return a}}),e.getOption()},s[2]=function(t){var e,a=[],s=0,i=[];for(var o in t.ySeries)if(!y.isEmpty(t.ySeries[o]))for(var n in t.ySeries[o]){for(var l=[],r=0;r<t.xData.length;r++)l.push({value:t.ySeries[o][n][r],name:t.xData[r]});a.push({name:n,type:"pie",radius:w.isMb?"120px":"150px",center:["50%",400*s+200+"px"],label:{normal:{formatter:w.isMb?"{b}\n{d}%":"{a}\n {b}: {d}%"}},data:l}),s++}for((e=new p.Echart).title={text:"订单明细图",x:"center"},w.isMb||(e.tooltip={trigger:"item",show:!0,axisPointer:{type:"cross",crossStyle:{color:"#999"}},formatter:function(t){var e,a="";return e=g.BwRule.formatText(t.value,h.getCols(t.seriesName),!1),a+=t.seriesName+"："+e+"<br/>"}}),e.title=w.isMb?{text:"订单明细图",x:"center",top:"20px"}:{text:"订单明细图",x:"center"},e.legend=w.isMb?{type:"scroll",top:"0%",left:0,data:t.legend}:{type:"scroll",orient:"vertical",right:"3%",top:20,bottom:0,data:t.xData,pageIconColor:"red"},r=0;r<t.xData.length;r++)i.push(u.getRandomCol());return e.color=i,e.series=a,e.getOption()},s[3]=function(t){var e,a=s[0].call(this,t);for(e=0;e<a.series.length;e++)a.series[e].smooth=!0,a.series[e].areaStyle={normal:{color:new o.graphic.LinearGradient(0,0,0,1,[{offset:0,color:a.color[e],opacity:1},{offset:1,color:a.color[e],opacity:1}])}};return a},s),this.initModal(),this.getSelectData(),this.replaceDataName();for(var e=t.allData(),a=this.para.getTablePara().keyField,i=0;i<e.length;i++)this.getLinkCol(e[i],a)}return u.prototype.getSelectData=function(){var t,e=this.para.getVisibleCol(),a=[],s=[];for(t=0;t<this.para.cols.length;t++)this.para.cols[t].isNumber&&-1<e.indexOf(this.para.cols[t].name)&&s.push({value:this.para.cols[t].name,text:this.para.cols[t].title});for(t=0;t<this.para.cols.length;t++)-1<e.indexOf(this.para.cols[t].name)&&a.push({value:this.para.cols[t].name,text:this.para.cols[t].title});this.chartRow=a,this.chartCol=s,this.chartType=[{value:0,text:"折线图"},{value:1,text:"柱形图"},{value:2,text:"饼图"},{value:3,text:"面积图"}]},u.prototype.initModal=function(){var p=this,f=this,t=new s.InputBox,e=new a.Button({key:"okBtn",content:"确认",type:"primary",onClick:function(){var t=!0;if(0===p.chartCol.length&&(v.Modal.toast("纵坐标无统计字段，无法统计"),t=!1),0===p.coms.col.get().length&&(v.Modal.toast("请选择至少一个纵坐标"),t=!1),0===(p.coms.range.get()[0]?p.para.selectedData().length:p.para.allData().length)&&(v.Modal.toast("无可统计数据，请重新选择"),t=!1),t){p.modal.isShow=!1;var e=p.para.getTablePara().isReplaceTable;if(e){var o,a,s,i=p.para.getWrapper(),n=w.isMb?b.closest(i,"li"):i.parentNode;i.style.display="block",(o=document.createElement("div")).className="Echart_body",o.style.height=w.isMb?"80vh":"450px",o.style.width=w.isMb?"700px":i.offsetWidth+"px",i.style.display="none";var l=b.query(".Echart_body",n);y.isNotEmpty(l)&&b.remove(l),i.parentNode.appendChild(o);var r=f.coms.type,c=f.getChartInput();f.generateGraph(o,r.get()[0],c),o.style.background="white",a=y.isMb?b.query(".icon-biaoge",n).parentNode:b.query(".statistics-table",n.parentNode.parentNode),y.isMb?a.classList.remove("hide"):a.style.display="inline-block";var d=null;b.on(a,"click",d=function(t){i.style.display="block",b.remove(o),!y.isMb&&(a.style.display="none"),b.off(a,"click",d)});var h=n.offsetHeight;(s=b.query(".panel-tools",n.parentElement.parentElement))&&b.on(b.query(".panel-fullscreen",s),"click",function(t){t.preventDefault(),setTimeout(function(){var t=n.parentElement,e=t.classList.contains("is-fullscreen"),a=h>t.offsetHeight?h:t.offsetHeight,s=t.offsetWidth+"px",i=e?a-b.query(".panel-heading",t).offsetHeight:h;o.style.width=s,o.style.height=i+"px",t.style.overflowY="scroll",t.style.overflowX="hidden",p.myChart.resize()},0)}),p.para.callback&&p.para.callback()}else if(!e&&w.isMb)m(["Modal","Button"],function(t,e){var a=b.create('<div class="Echart_body" style="width: 100vw; height: calc(100vh - 44px); overflow-x: hidden;"></div>'),s=new t.Modal({position:"full",body:a,isOnceDestroy:!0,header:"图形报表"});s.body.parentElement.parentElement.classList.add("myChart"),s.body.parentElement.style.maxHeight="none",s.body.parentElement.setAttribute("style","height:calc(100vh - 44px);");var i=f.coms.type,o=f.getChartInput();f.generateGraph(s.body,i.get()[0],o)});else{var u=new v.Modal({className:"tempModal",body:x.create('<div class="Echart_body" style="height:450px; width: 700px;"></div>'),container:f.para.container,isOnceDestroy:!0,isBackground:!1,onLarge:function(){var t=b.query(".tempModal",document.body),e=b.query(".head-wrapper",t),a=b.query(".Echart_body",t),s=t.offsetHeight-e.offsetHeight,i=t.offsetWidth-40,o=a.style,n=a.parentElement.style;p.isLarge?(n.height=s+"px",n.maxHeight="none"):(o.width="700px",n.height="500px"),p.isLarge&&!p.isPie?(o.width=i+"px",o.height=s+"px",p.isLarge=!1):p.isLarge||p.isPie?p.isLarge&&p.isPie?(o.width=i+"px",p.isLarge=!1):!p.isLarge&&p.isPie&&(p.isLarge=!0):(o.height="450px",p.isLarge=!0),p.myChart.resize()},header:{title:"统计结果",isFullScreen:!0}});r=f.coms.type,c=f.getChartInput();f.generateGraph(u.body,r.get()[0],c)}}}});t.addItem(e),w.isMb?(this.modal=new v.Modal({header:"图表统计",position:"full",container:this.para.container,isOnceDestroy:!0}),this.modal.modalHeader.rightPanel=t,this.modal.bodyWrapper.parentElement.classList.add("myChart")):this.modal=new v.Modal({header:"图表统计",container:this.para.container,className:"echart",width:w.isMb?null:"500px",isBackground:!1,footer:{rightPanel:t}})},u.prototype.initHtmlTpl=function(t,e){var o=this;switch(t){case"type":this.coms.type=new i.SelectBox({container:e,select:{multi:!1,callback:function(t){}},data:this.chartType});break;case"row":this.coms.row=new n.SelectInput({container:e,data:this.chartRow,onSet:function(t,e){},className:"selectInput",clickType:1,readonly:!0});break;case"col":this.coms.col=new i.SelectBox({container:e,select:{multi:!0,callback:function(t){var e,a=o.getDataType(o.chartCol[t].text),s=o.coms.col;if(a===g.BwRule.DT_DATETIME||a===g.BwRule.DT_TIME)for(e=0;e<o.chartCol.length;e++){(i=o.getDataType(o.chartCol[e].text))!=g.BwRule.DT_DATETIME&&i!=g.BwRule.DT_TIME&&s.unSet([e])}else for(e=0;e<o.chartCol.length;e++){var i;(i=o.getDataType(o.chartCol[e].text))!==g.BwRule.DT_DATETIME&&i!==g.BwRule.DT_TIME||s.unSet([e])}}},data:this.chartCol});for(var a=[],s=0;s<this.chartCol.length;s++)o.getDataType(this.chartCol[s].text)===g.BwRule.DT_MONEY&&a.push(s);this.coms.col.set(a);break;case"range":this.coms.range=new i.SelectBox({container:e,select:{multi:!1,callback:function(t){}},data:[{value:0,text:"全部数据"},{value:1,text:"选定数据"}]})}},u.prototype.replaceDataName=function(){var e=this;this.body=this.modal.bodyWrapper;var t=this.htmlTpl();this.body.innerHTML=t,x.queryAll("[data-name]",this.body).forEach(function(t){e.initHtmlTpl(t.dataset.name,t)});var a=this.coms.row;this.chartRow[0]&&a.set(this.chartRow[0].value)},u.prototype.generateGraph=function(r,t,e){var c=this;this.myChart=o.init(r);var a=this.generateChartOption[t].call(this,e);a.series[0]&&"pie"===a.series[0].type?(r.parentElement.style.overflowY="scroll",r.parentElement.parentElement.style.overflowY="scroll",400,r.style.height=400*a.series.length+"px",this.isPie=!0,this.myChart.resize()):this.isPie=!1,this.isLarge=!0,this.myChart.setOption(a),this.myChart.on("click",function(s){var t=!1,e=function(t){var e,a;for(a in c.hasLinkCol)for(e=0;e<c.hasLinkCol[a].length;e++)if(c.hasLinkCol[a][e].name==s.value){t(c.hasLinkCol[a][e].src);break}};if(w.isMb){e(function(){t=!0});var a=b.query(".detailDiv",r);a&&r.removeChild(a);var i=s.value;s.seriesName&&(i=g.BwRule.formatText(s.value,c.getCols(s.seriesName),!1));var o=void 0;o="xAxis"===s.componentType?'<p style="color:white; margin:0 0;">'+s.value+"</p> ":'<p style="color:white; margin:0 0;">'+s.name+'</p>\n                            <p style="color:white; margin:0 0;">'+s.seriesName+":"+i+"</p>\n                            ";var n=document.createElement("div");if(n.className="detailDiv",n.setAttribute("style","top:"+(s.event.offsetY-55)+"px;left:"+(s.event.offsetX+10)+"px"),n.innerHTML=o,t){var l=document.createElement("p");l.setAttribute("style","color:white;text-align:center;"),l.innerHTML="点击查看>>",n.appendChild(l),b.on(l,"click",function(t){e(function(t){w.window.open({url:t})})})}r.appendChild(n)}else e(function(t){w.window.open({url:t})})})},u.prototype.htmlTpl=function(){return'<div class="EChart_tabFirst"><div class="row"><div class="col-xs-4"><fieldset><legend>类型</legend><div data-name="type"></div></fieldset></div><div class="col-xs-4"><fieldset><legend>纵坐标</legend><div class="colClass"><div data-name="col"></div></div></fieldset></div><div class="col-xs-4"><fieldset><legend>横坐标</legend><div class="rowClass"><div data-name="row"></div></div></fieldset><fieldset><legend>范围</legend><div data-name="range"></div></fieldset></div></div></div>'},u.prototype.getModal=function(){return this.modal},u.prototype.getChartInput=function(){var t,e,a,s=this.coms.row.get(),i=this.coms.col.get(),o=[],n=[],l=[],r={},c=this.coms.range.get()[0]?this.para.selectedData():this.para.allData();for(t=0;t<i.length;t++)o.push(this.chartCol[i[t]].value),n.push(this.chartCol[i[t]].text);for(-1<(l=function(t){var e,a=[],s={};for(e=0;e<t.length;e++)s[t[e]]||(a.push(t[e]),s[t[e]]=1);return a}(this.para.colDataGet(s))).indexOf(null)&&l.splice(l.indexOf(null),1),e=0;e<l.length;e++)for(t=0;t<c.length;t++)if(c[t][s]===l[e])for(a=0;a<o.length;a++)r[n[a]]||(r[n[a]]={}),r[n[a]][l[e]]||(r[n[a]][l[e]]=0),r[n[a]][l[e]]=r[n[a]][l[e]]+c[t][o[a]];var d={money:{},count:{},time:{}};for(var h in r){var u=this.getDataType(h);for(var p in u===g.BwRule.DT_MONEY?d.money[h]=[]:u===g.BwRule.DT_DATETIME||u===g.BwRule.DT_TIME?d.time[h]=[]:d.count[h]=[],l=[],r[h])l.push(p),u===g.BwRule.DT_MONEY?d.money[h].push(r[h][p]):u===g.BwRule.DT_DATETIME||u===g.BwRule.DT_TIME?d.time[h].push(r[h][p]):d.count[h].push(r[h][p])}var f={};return f.legend=n,f.ySeries=d,f.xData=l,f},u.prototype.getDataType=function(t){for(var e=0;e<this.para.cols.length;e++)if(this.para.cols[e].title===t)return this.para.cols[e].dataType},u.prototype.getLinkCol=function(n,l){var r=this,t=this.para.cols;t.forEach(function(t,e){var a,s,i=t.content,o=c.drillUrlGet(i,n,l);y.isNotEmpty(o)&&(a=i,s=o,r.hasLinkCol[a.caption]||(r.hasLinkCol[a.caption]=[]),r.hasLinkCol[a.caption].push({name:n[a.name],src:s}))})},u}()).getRandomCol=function(){return"rgb("+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+")"},e.yType={money:"金额",count:"数量",time:"时间"},e}),define("NewStatisticBase",["require","exports","Modal","FastBtnTable"],function(t,e,d,h){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var u=G.d,p=G.tools,f=BW.sys,a=function(){function t(){}return t.prototype.tableRender=function(t,e,a){void 0===a&&(a=!1);var s=u.create('<div style="height: 100%;"></div>');if(0<t.data.length)for(var i=0,o=t.data.length;i<o;i++)for(var n in t.data[i])"--"===t.data[i][n]&&(t.data[i][n]="");var l,r=a?t.cols[0].length:t.cols.length;l=r<=2?"400px":2<r&&r<=7?"600px":"1000px",f.isMb?new d.Modal({header:"统计结果",body:s,position:"full",container:e,isOnceDestroy:!0}):new d.Modal({body:s,isOnceDestroy:!0,isBackground:!1,container:e,width:l,height:"90%",header:{title:"统计结果",isFullScreen:!0}});var c={cols:Array.isArray(t.cols[0])?t.cols:[t.cols],data:t.data,container:s,isFullWidth:!0,pseudo:{type:"number"},isResizeCol:!0,clickSelect:!0,dragSelect:!p.isMb};!p.isMb&&(c.btn={name:["search","statistic","export"],type:"button"}),new h.FastBtnTable(c)},t}();e.NewStatisticBase=a}),define("NewCount",["require","exports","NewStatisticBase","SelectInput","Modal","SelectInputMb"],function(t,e,a,i,n,l){"use strict";var r=BW.sys,c=G.d,d=G.tools;return function(a){function t(t){var e=a.call(this)||this;return e.para=t,e.modal=null,e.initModal(),e}return __extends(t,a),t.prototype.count=function(t){var e=this.para.colDataGet(t),a={};return e.forEach(function(t){(t=d.isEmpty(t)?"-空-":t)in a?a[t]++:a[t]=1}),a},t.prototype.initModal=function(){var o=this;this.modal=new n.Modal({header:"统计",body:c.create("<span></span>"),className:"statistic",width:"220px",top:200,container:this.para.container,isBackground:d.isMb,position:d.isMb?"center":"default",footer:{},isMb:!1,onOk:function(){var t={cols:[{title:s.getText(),name:"colName"},{title:"数量",name:"count"}],data:[]},e=o.para.colDataGet(s.get());for(var a in e)t.data.push({colName:a,count:e[a]});o.tableRender(t,o.para.container)}});var t=this.para.getVisibleCol().map(function(t){for(var e=o.para.cols,a=-1,s=0,i=void 0;i=e[s];s++)if(i.name===t){a=s;break}return{text:e[a].title,value:t}}),s=new(r.isMb?l.SelectInputMb:i.SelectInput)({container:this.modal.body,data:t,readonly:!0,clickType:0});s.set(t[0].value)},t.prototype.getModal=function(){return this.modal},t}(a.NewStatisticBase)});