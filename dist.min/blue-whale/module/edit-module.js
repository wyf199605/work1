define("EditModule",["require","exports","AssignModule","UploadModule","AssignTextModule","PickModule","TextInput","SelectInput","Virtual","CheckBox","Datetime","RichText","RichTextMb","SelectInputMb","DatetimeMb","Toggle","LookupModule","Validate","Modal","BwRule","RichTextModal"],function(t,e,s,p,c,u,f,m,h,v,y,g,E,x,b,w,M,k,A,T,D){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var I=G.tools,j=BW.CONF,S=BW.sys,n=function(){function i(t){var l,o,r,a,d=this;if(this.para=t,this.coms={},this.comsExtraData={},this.nameFields={},this.ajax=new T.BwRule.Ajax,this.comTnit={pickInput:function(n){return new u.PickModule({container:n.dom,field:n.field,data:n.data,dataGet:function(){return n.data?n.data:d.get()},onGetData:function(t,e){d.pickOnGet(n,t,e)}})},tagsInput:function(n){if("table"===d.para.type)return d.comTnit.assignText(n);return new s.default({data:n.data,container:n.dom,name:n.field.name,pickerUrl:n.field.dataAddr?j.siteUrl+T.BwRule.reqAddr(n.field.dataAddr):"",ajaxUrl:n.field.assignAddr?j.siteUrl+T.BwRule.reqAddr(n.field.assignAddr):"",multi:!0,sepValue:";",onSet:d.getAssignSetHandler(n.field),onGetData:function(t,e){d.pickOnGet(n,t,e)}})},assignText:function(n){return new c.AssignTextModule({data:n.data,container:n.dom,name:n.field.name,pickerUrl:n.field.dataAddr?j.siteUrl+T.BwRule.reqAddr(n.field.dataAddr):"",ajaxUrl:n.field.assignAddr?j.siteUrl+T.BwRule.reqAddr(n.field.assignAddr):"",onSet:d.getAssignSetHandler(n.field),onGetData:function(t,e){d.pickOnGet(n,t,e)}})},file:function(c){var u=new p.default({nameField:c.field.name,container:c.dom,uploadUrl:BW.CONF.ajaxUrl.fileUpload,onComplete:function(t){var e,n=t.data;if(!d.para.fields.some(function(t){return t.field.name.toLowerCase()===n.md5Field.key.toLowerCase()}))return A.Modal.alert("无法找到附件，附件是否进行过改造"),void(u.com.text="");var a={};for(var i in n){var o=n[i],r=o.key,s=o.value;a[r.toLocaleUpperCase()]=I.str.toEmpty(s)}for(var l in c.onExtra&&c.onExtra(a,Object.keys(a)),d.comsExtraData[c.field.name]={},a)d.coms[l]?d.set(((e={})[l]=a[l],e)):d.comsExtraData[c.field.name][l]=n[l]}});return u},richText:function(t){return new(S.isMb?E.RichTextMb:g.RichText)({container:t.dom})},richTextInput:function(t){return new D.RichTextModal({container:t.dom})},text:function(t){return new f.TextInput({container:t.dom})},selectInput:function(o){if("lookup"===o.field.elementType)return new M.LookupModule({container:o.dom,field:o.field,rowData:o.data,onExtra:function(n){n&&setTimeout(function(){var t,e=((t={})[o.field.name]=n.text,t[o.field.lookUpKeyField]=n.value,t);o.onExtra(e,[o.field.lookUpKeyField])},100)}});var t=o.field.atrrs.valueLists?o.field.atrrs.valueLists.split(/,|;/):null,e=Array.isArray(t)?t:null,n=o.field.dataAddr?{fun:function(t,e,i){T.BwRule.Ajax.fetch(t,{needGps:o.field.dataAddr.needGps}).then(function(t){var e=t.response,n=[];e.data[0]&&(n=Object.keys(e.data[0]));var a=e.data.map(function(e){return{value:e[o.field.name],text:n.map(function(t){return e[t]}).join(",")}});i(a)}).finally(function(){i()})},url:j.siteUrl+T.BwRule.reqAddr(o.field.dataAddr,o.data)}:null;return new(S.isMb?x.SelectInputMb:m.SelectInput)({container:o.dom,data:e,ajax:n,useInputVal:!0})},virtual:function(t){return new h.Virtual},toggle:function(t){return"table"===d.para.type?new m.SelectInput({container:t.dom,data:[{value:"1",text:"是"},{value:"0",text:"否"}]}):S.isMb?new w.Toggle({container:t.dom}):new v.CheckBox({container:t.dom})},datetime:function(t){return new(S.isMb?b.DatetimeMb:y.Datetime)({container:t.dom,format:t.field.displayFormat})},accessory:function(t){return null}},this.assign=(o=function(o,r,t,s){I.isEmpty(r)||I.isEmpty(o.assignAddr)||d.ajax.fetch(j.siteUrl+T.BwRule.reqAddr(o.assignAddr,t),{cache:!0}).then(function(t){var e=t.response,n=I.keysVal(e,"data",0),a=function(t,n){var a={},i={};if("object"!=typeof n||!n)return i;var o=Object.keys(n);return o.forEach(function(t){var e=n[t];a[t]="string"==typeof e?e.split(";"):[e]}),("string"==typeof t?t.split(";"):[t]).forEach(function(t,e){I.isEmpty(t)||o.forEach(function(t){i[t]||(i[t]=[]),i[t].push(a[t][e])})}),i}(r,n);for(var i in a)a[i]=Array.isArray(a[i])?a[i].join(";"):"";l(o,a),s&&s(a,o.assignSelectFields,!0)})},{init:function(t,e){if(e){var n=e.field,a=e.data,i=e.onExtra;n&&"tagsinput"===e.field.comType||(t.onSet=function(t){var e;(a=a||{})[n.name]!=t&&o(n,t,Object.assign({},a,((e={})[n.name]=t,e)),i)})}},assign2extra:l=function(t,a){var e=t.assignSelectFields,i=t.name;Array.isArray(e)&&e.forEach(function(t){var e,n=a[t];t!==i&&(d.coms[t]?d.set(((e={})[t]=n,e)):(d.comsExtraData[i]||(d.comsExtraData[i]={}),d.comsExtraData[i][t]=n))})},assignSend:o,checkAssign:function(t,e){for(var n in t){var a=d.nameFields[n];a&&a.field&&a.field.assignAddr&&o(a.field,t[n],t,e)}}}),this.validate=(r=null,a=function(t,e){var n,a=d.coms[t],i=d.nameFields[t];if(a&&i)return function(n){if(!r.get(n.name)){var a=[];T.BwRule.isNumber(n.dataType)&&(I.isNotEmpty(n.caption)?a.push({rule:"number",title:n.caption}):a.push({rule:"number"})),["maxLength","maxValue","minLength","minValue","requieredFlag","regExp"].forEach(function(t){var e=n.atrrs[t];I.isEmpty(e)||a.push({rule:t,value:e})}),r.add(n.name,a)}}(i.field),e=I.isUndefined(e)?d.get(i.field.name)[i.field.name]:e,r.start(((n={})[t]=e,n))},{start:function(t,e){null===r&&null===r&&(r=new k.Validate);var n={};return t?n=a(t,e):d.para.fields.forEach(function(t){n=I.obj.merge(a(t.field.name),n)}),n}}),Array.isArray(t.fields)&&(t.fields.forEach(function(t){d.nameFields[t.field.name]=t}),void 0===t.auto||t.auto))for(var e=0,n=t.fields;e<n.length;e++){var i=n[e];this.init(i.field.name)}}return Object.defineProperty(i.prototype,"assignPromise",{get:function(){return this.ajax.promise},enumerable:!0,configurable:!0}),i.prototype.getDom=function(t){return this.coms[t]},i.prototype.init=function(t,e){var n=this.nameFields[t];return(n||e)&&(e&&e.field&&(n=this.nameFields[t]=e),this.coms[t]=this.initFactory(n.field.comType,n)),this.coms[t]},i.prototype.pickOnGet=function(t,e,n){var a=this,i=t.field.name,o=n?n.split(","):[];e.forEach(function(n){var t=function(e){a.comsExtraData[i]||(a.comsExtraData[i]={}),o&&o.forEach(function(t){t===e&&(a.comsExtraData[i][e]=n[e])})};for(var e in n)t(e)}),this.comsExtraData[i]&&t.onExtra&&t.onExtra(I.obj.copy(this.comsExtraData[i]),o),this.assign.checkAssign(this.comsExtraData[i],t.onExtra)},i.tableComTypeGet=function(t){var e={richText:"richTextInput"};return t in e?e[t]:t},i.prototype.initFactory=function(t,e){"table"===this.para.type&&(t=i.tableComTypeGet(t));var n=e?e.field:null;n&&(n.multiPick&&"ELEMENTNAMELIST"===n.name||"pick"===n.elementType?t="pickInput":("value"===n.elementType||"lookup"===n.elementType||n.atrrs.valueLists)&&(t="selectInput")),t in this.comTnit||(t="text"),e&&e.dom||(t="virtual");var a=this.comTnit[t](e);return this.assign.init(a,e),a},i.prototype.getAssignSetHandler=function(i){var o=this;return function(a){if("object"==typeof a){var t=i.assignSelectFields;Array.isArray(t)&&t.forEach(function(t){var e,n=a&&Array.isArray(a[t])?a[t].join(";"):"";o.coms[t]?t!==i.name&&o.set(((e={})[t]=n,e)):(o.comsExtraData[i.name]||(o.comsExtraData[i.name]={}),o.comsExtraData[i.name][t]=n)})}}},i.prototype.set=function(t){var e=this.coms;for(var n in t)e[n]||(e[n]=this.initFactory("virtual",this.nameFields[n])),e[n].set(I.str.toEmpty(t[n]))},i.prototype.get=function(t){var s=this,e={},l=this.coms,c=this.comsExtraData,n=function(t){var e,n=c[t],a=((e={})[t]=l[t].get(),e);for(var i in a){var o=I.keysVal(s.nameFields,i,"field"),r=a[i];o&&(r&&!isNaN(r)&&T.BwRule.isNumber(o.dataType)&&(r=Number(r)),a[i]=T.BwRule.maxValue(r,o.dataType,o.atrrs.maxValue))}return n?I.obj.merge(n,a):a};if(t)return n(t);for(var a in l)e=I.obj.merge(e,n(a));return e},i.checkValue=function(t,a,r){for(var s=t.name,l=t.chkAddr,e=t.chkAddr.varList.map(function(t){return t.varName}),i={errors:[],okNames:[]},n=0,o=e;n<o.length;n++){var c=o[n];null===a[c]||void 0===a[c]?i.errors.push({name:c,msg:"不能为空"}):i.okNames.push(c)}return new Promise(function(o){if(i.errors[0])o(i);else{var t=T.BwRule.reqAddrFull(l,a),e=t.addr,n=t.data;T.BwRule.Ajax.fetch(j.siteUrl+e,{silent:!0,type:"POST",data:[n]}).then(function(t){var e=t.response,n=I.keysVal(e,"body","bodyList",0)||{type:"",showText:""},a=n.type,i=n.showText;0===a?o({errors:[{name:s,msg:i}]}):(1===a&&A.Modal.confirm({msg:i,callback:function(t){t||r()}}),o({okNames:l.varList.map(function(t){return t.varName})}))}).catch(function(){o({okNames:l.varList.map(function(t){return t.varName})})})}})},i.prototype.destroy=function(t){this.coms[t]&&(this.coms[t].destroy(),this.comsExtraData[t]=null,delete this.coms[t])},i}();e.EditModule=n}),define("LookupModule",["require","exports","FormCom","SelectInput","SelectInputMb","BwRule"],function(t,e,n,i,o,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=BW.sys,l=G.tools,a=function(e){function t(t){var a=e.call(this,t)||this;return a.para=t,a.options=[],a.selectInput=new(s.isMb?o.SelectInputMb:i.SelectInput)({container:a.para.container,ajax:{fun:function(t,e,n){a.ajax(n)}},readonly:!!t.field.noEdit,onSet:function(t,e){a.set(t.value),a.para.onExtra&&a.para.onExtra(t)}}),a}return __extends(t,e),t.prototype.ajax=function(e){var n=this,t=this.para,a=t.field,i=t.rowData;r.BwRule.getLookUpOpts(a,i).then(function(t){n.options=t,e(t?t.map(function(t){return Object.assign({},t)}):[])})},t.prototype.get=function(){return this.value},t.prototype.set=function(t){this.value=t},Object.defineProperty(t.prototype,"value",{get:function(){return this.selectInput.getText()},set:function(a){var i=this;if(a="object"==typeof a&&null!==a?a.value:a,l.isEmpty(this.options))this.ajax(function(t){i.selectInput.setPara({data:t});for(var e=0;e<t.length;e++){var n=t[e];if(n.value===a){i.selectInput.set(n),"function"==typeof i.onSet&&i.onSet(n);break}}});else for(var t=0;t<this.options.length;t++){var e=this.options[t];if(e.value===a){this.selectInput.set(e),"function"==typeof this.onSet&&this.onSet(e);break}}},enumerable:!0,configurable:!0}),t.prototype.wrapperInit=function(t){},t}(n.FormCom);e.LookupModule=a}),define("PickModule",["require","exports","Modal","SelectBox","DropDown","TextInput","Spinner","BwRule","NewTablePage"],function(t,e,a,i,o,n,r,s,l){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var c=G.d,u=BW.CONF,d=BW.sys,p=function(n){function t(t){var e=n.call(this,{icons:["iconfont icon-arrow-down"],readonly:!0,iconHandle:function(){e.pickInit()},container:t.container})||this;return e.component=[],e.p=t,e}return __extends(t,n),t.prototype.pickInit=function(){if(this.modal)this.modal.isShow=!0;else{var t=!0,e=void 0,n=void 0;this.p.field.multiPick?n=this.p.field.multiPick.dataAddr:"pick"===this.p.field.elementType&&(n=this.p.field.dataAddr,this.body=h("div",null),t=!(e={output:"json"})),this.ajaxLoad(u.siteUrl+s.BwRule.reqAddr(n,this.p.dataGet()),e,t)}},t.prototype.getData=function(){var n=this,a="";if(n.p.field.multiPick){for(var t in n.component){var e=n.component[t].getSelect();e[0]&&e.forEach(function(t,e){a+=t.text+";"})}a=a.substr(0,a.length-1),n.set(a)}else{var i=[],o=n.bwTable.tableModule.main.ftable.selectedRowsData;o.forEach(function(t){for(var e in t)e===n.fromField&&i.push(t[e])}),n.set(i.join(";")),n.p.onGetData(o,n.otherField)}n.modal.isShow=!1},t.prototype.ajaxLoad=function(t,e,n){var a=this;a.p.field.multiPick&&(a.spinner=new r.Spinner({el:c.query(".btn-group",a.p.container),type:1}),a.spinner.show()),s.BwRule.Ajax.fetch(t,{data:e}).then(function(t){var e=t.response;if(a.p.field.multiPick)a.multiPick(e),a.spinner.hide();else{var n=e.body.elements[0];a.modalInit(),a.bwTable=new l.BwTableElement({tableEl:n,container:a.body}),a.fromField=n.fromField,a.otherField=n.otherField}})},t.prototype.modalInit=function(){var t=this,e="",n="modal-pick";"pc"===d.os?e="500px":this.p.field.multiPick?n="modal-multiPick":e="300px",this.modal=new a.Modal({body:this.body,header:this.p.field.caption,className:n,width:e,height:"80%",container:c.closest(this.para.container,".page-container[data-src]"),isBackground:!1,footer:{},top:40,isMb:!1}),this.modal.onOk=function(){t.getData()}},t.prototype.multiPick=function(t){var i=this,e=t.data;e[0]?this.body=h("div",{className:"element-box"}):this.body=h("div",null,"暂无数据"),e.forEach(function(a){i.Dom=h("div",{className:"element-col"}),i.body.appendChild(i.Dom),i.titleAppend(a,"one-trees");var e=[];a.child.forEach(function(t){if(t.child[0]){var n=[];i.titleAppend(t,"two-trees",a),t.child.forEach(function(t){if(t.child[0]){var e=[];i.titleAppend(t,"three-trees",a),t.child.forEach(function(t){i.dataPush(e,t)}),e[0]&&i.createComponent(e,t,"four-trees")}else i.dataPush(n,t)}),n[0]&&i.createComponent(n,t,"three-trees")}else i.dataPush(e,t)}),e[0]&&i.createComponent(e,a,"two-trees")}),i.modalInit()},t.prototype.titleAppend=function(t,e,n){var a=n&&n.ELEMENTTYPEID;if(n&&1===a||2===a)this.createComponent([{text:t.ELEMENTNAME,value:t.ELEMENTID}],t,"two-trees");else{var i=h("h5",{className:e},t.ELEMENTNAME);t.MEMO&&i.setAttribute("title",t.MEMO),this.Dom.appendChild(i)}},t.prototype.dataPush=function(t,e){t.push({value:e.ELEMENTID,text:e.ELEMENTNAME})},t.prototype.createComponent=function(t,e,n){if(1===e.ELEMENTTYPEID){var a=h("div",{className:n});this.Dom.appendChild(a),this.component[e.ELEMENTID]=new i.SelectBox({select:{multi:!1,isRadioNotchecked:0===e.REQUIRED,callback:function(){}},container:a,data:t})}else this.component[e.ELEMENTID]=new o.DropDown({el:this.Dom,data:t,multi:!0,inline:!0,className:n,onMultiSelect:function(){}})},t}(n.TextInput);e.PickModule=p}),define("AssignModule",["require","exports","AssignModuleBasic","TagsInput","Modal","BwRule"],function(t,e,n,i,s,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var l=G.tools,a=function(a){function t(t){var n=a.call(this,t)||this;n.para=t,n.assignData={},n.ajax=new o.BwRule.Ajax,n.para=n.paraInit(t),n.tagsInput=new i.TagsInput(n.para),n.initDeleteEvent();var e=n.para.container.parentElement.querySelector('span[data-action="picker"]');return n.para.container.parentElement.dataset.name=t.name,n.initPicker(e,n.para.pickerUrl,t.data,function(e){var t=e.data.map(function(t){return t[e.fromField]}).join(";");n.set(t),n.para.onGetData(e.data,e.otherField)}),n}return __extends(t,a),t.prototype.paraInit=function(o){var r=this;if(o.ajaxUrl){o.ajax=function(n){var t;return r.ajax.fetch(o.ajaxUrl,{cache:!0,data:(t={},t[o.name]=n,t)}).then(function(t){var e=t.response;return a(n,e)})};var a=function(t,e){var n=e.data[0],a=Object.keys(n),i=[];return n[a[0]]?(r.assignData=r.assignDataGet(t,n),t.split(o.sepValue).forEach(function(t,e){l.isEmpty(t)||i.push({value:t,text:r.assignData[a[0]][e]+"("+t+")"})}),r.para.onSet(r.assignData),i):(s.Modal.alert('查询"'+t+'"无结果'),[])};return o}},t.prototype.initDeleteEvent=function(){var e=this;this.tagsInput.on("beforeItemRemove",function(n){var a=-1;for(var t in e.tagsInput.get().forEach(function(t,e){t===n.item&&(a=e)}),e.assignData)e.assignData[t].splice(a,1);e.para.onSet(e.assignData)})},t.prototype.get=function(){var e=this,n="";return this.tagsInput.get().forEach(function(t){n+=t.value,n+=e.sepValue}),n.slice(0,-1)},t.prototype.set=function(t){this.tagsInput.set(t)},Object.defineProperty(t.prototype,"value",{get:function(){var e=this,n="";return this.tagsInput.get().forEach(function(t){n+=t.value,n+=e.sepValue}),n.slice(0,-1)},set:function(t){this.tagsInput.set(t)},enumerable:!0,configurable:!0}),t}(n.AssignModuleBasic);e.default=a}),define("AssignTextModule",["require","exports","AssignModuleBasic","TextInput"],function(t,e,a,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=G.d,o=function(e){function t(t){var n=this;return t.readonly=!1,(n=e.call(this,Object.assign({},t,{icons:t.pickerUrl?["iconfont icon-arrow-down"]:null}))||this).para=t,n.assignBasic=new a.AssignModuleBasic,t.pickerUrl&&(n.iconGroup.parentElement.dataset.name=t.name,n.assignBasic.initPicker(n.iconGroup,n.para.pickerUrl,t.data,function(e){var t=e.data.map(function(t){return t[e.fromField]}).join(";");n.set(t),n.para.onGetData(e.data,e.otherField)})),n}return __extends(t,e),t.prototype.set=function(t){this.input&&(this.input.value=t),"function"==typeof this.onSet&&this.onSet(t)},t.prototype.destroy=function(){this.assignBasic&&this.assignBasic.iframe&&(i.remove(this.assignBasic.iframe.get()),this.assignBasic.destroy())},t}(n.TextInput);e.AssignTextModule=o}),define("AssignModuleBasic",["require","exports","FormCom","Modal"],function(t,e,n,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var l=G.tools,s=G.d,c=BW.sys,i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.sepValue=";",t}return __extends(t,e),t.prototype.get=function(){},t.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},Object.defineProperty(t.prototype,"value",{get:function(){},set:function(t){},enumerable:!0,configurable:!0}),t.prototype.initPicker=function(t,e,n,a){var i=this,o=!0;if(t){var r=t.parentElement.dataset.name;c.isMb&&(this.iframe=l.iPage(e,{id:"iframe_"+r})),s.on(t,"click",function(){localStorage.setItem("fromPickCaption",r),localStorage.setItem("fromPickData",JSON.stringify(l.str.toEmpty(n))),"pc"===c.os?(o&&(i.initIframe(e),o=!1),i.contactModal.isShow=!0):i.iframe.show(),s.once(window,"selectContact",function(t){i.contactModal&&(i.contactModal.isShow=!1),a(t.detail)})})}},t.prototype.initIframe=function(t){var s=this;if(t){var e=h("iframe",{className:"pageIframe",src:l.url.addObj(t,{isMb:!0},!1)});this.contactModal=new a.Modal({body:e,className:"contact-modal"}),e.onload=function(){var t=s.contactModal.body,e=t.contentDocument.body,n=e.querySelector("#list ul.mui-table-view"),a=e.querySelector("#list"),i=document.createElement("div"),o=h("style",null,"header a.sys-action-back{display: none} .ulOverFlow{ height:448px; overflow-y : auto} #list{height: 100vh}");t.contentDocument.head.appendChild(o),a.querySelector(".mui-scroll").remove();var r=a.querySelector(".mui-scrollbar");r&&r.remove(),i.classList.add("ulOverFlow"),i.appendChild(n),a.appendChild(i)}}},t.prototype.assignDataGet=function(t,n){var a=this,i={},o={};if("object"!=typeof n||!n)return o;var r=Object.keys(n);return r.forEach(function(t){var e=n[t];i[t]="string"==typeof e?e.split(a.sepValue):[e]}),("string"==typeof t?t.split(this.sepValue):[t]).forEach(function(t,e){l.isEmpty(t)||r.forEach(function(t){o[t]||(o[t]=[]),o[t].push(i[t][e])})}),o},t.prototype.wrapperInit=function(){},t}(n.FormCom);e.AssignModuleBasic=i});