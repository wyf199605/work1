define("Finger",["require","exports","ShellAction","Modal","Button","InputBox","IDB"],function(e,t,r,c,p,a,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var u=G.d,f=G.tools,n=function(){function e(e){var t;for(var n in this.erp=null,this.db=null,this.DBConf={storeName:"",version:1},this.verify="0",this._success=function(){},this._callFinger=function(){},this.erp=r.ShellAction.get().erp(),e)this.DBConf[n]=e[n];this.storeConf=((t={})[this.DBConf.storeName]=["userid","prints"],t),this.erp.callFinger({type:0}),this.callFingerMsg(),this.setFinger()}return e.prototype.againOpen=function(){this.erp.callFinger({type:0})},Object.defineProperty(e.prototype,"success",{set:function(e){this._success=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"callFinger",{set:function(e){this._callFinger=e},enumerable:!0,configurable:!0}),e.prototype.callFingerMsg=function(){var n=this;this.erp.callFingerMsg({callback:function(e){var t=JSON.parse(e.detail);n._callFinger&&n._callFinger(t)}})},e.prototype.setFinger=function(){var i=this;this.erp.setFinger({callback:function(e){var t=JSON.parse(e.detail),n=t.msg.fingerPrint,r=t.msg.fingerType;t.success?i.findFinger(r,n):(i.againOpen(),c.Modal.alert("指纹获取失败！"))}})},e.prototype.getUserId=function(r,i){var o=this,e=new a.InputBox({}),t=new p.Button({content:"确定",type:"primary",key:"okBtn"});e.addItem(t);var n=function(e){var t=e.body.querySelector("input").value.toUpperCase();if(f.str.toEmpty(t)){e.destroy();var n={userid:o.userid=t,type:r,print:i,verify:o.verify};o._success&&o._success(n)}else o.againOpen(),e.destroy(),c.Modal.toast("请重新录入指纹")},s=new c.Modal({header:"登记本地指纹ID",isOnceDestroy:!0,body:u.create('<div data-action="fingerModal">\n                                        <form>\n                                            <label>请输入您的员工号</label>\n                                            <input type="text" >\n                                        </form>\n                                    </div>'),footer:{rightPanel:e},isBackground:!1,onOk:function(){n(s)},onClose:function(){c.Modal.toast("请重新录入指纹"),o.againOpen()}});s.bodyWrapper.querySelector("input").focus(),u.on(s.bodyWrapper.querySelector("form"),"submit",function(e){e.preventDefault(),n(s)})},e.prototype.findFinger=function(n,r){var i=this;i.db=new s.IDB("fingerDB",i.DBConf.version,i.storeConf),i.db.success=function(){i.db.collection(i.DBConf.storeName).find(function(e){return void 0!==e.prints["type"+n]&&JSON.parse(i.erp.verifyFinger({data:{enterFinger:r,matchFinger:e.prints["type"+n][0],fingerType:n}}).data).success},function(e){if(f.isEmpty(e))i.verify="1",i.type=n,i.getUserId(n,r);else{i.verify="0";var t={userid:e[0].userid,type:n,print:r,verify:i.verify};i._success&&i._success(t)}})}},e.prototype.addFinger=function(n,r){var e=this,i=e.userid,o=e.type;"1"===e.verify&&void 0!==n&&(e.db=new s.IDB("fingerDB",e.DBConf.version,e.storeConf),e.db.success=function(){var t=e.store=e.db.collection(e.DBConf.storeName);t.update(function(e){return e.userid===i},function(e){return e.userid=i,void 0===e.prints["type"+o]&&(e.prints["type"+o]=[]),e.prints["type"+o].unshift(n),1<e.prints["type"+o].length&&e.prints["type"+o].pop(),e},function(){"function"==typeof r&&r()},function(){var e={userid:i,prints:{type0:[],type1:[],type2:[]}};e.prints["type"+o].push(n),t.insert(e,function(){"function"==typeof r&&r()})})})},e.prototype.destroy=function(){this.erp.cancelFinger();try{this.db.destroy()}catch(e){console.log(e)}},e}();t.Finger=n});