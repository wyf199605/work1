define("BwTableModule",["require","exports","BwRule","FastTable","FastBtnTable","TableBase","InputBox","Button","Modal","BwInventoryBtnFun","UploadModule","Loading","LayoutImage","ButtonAction","Inputs"],function(x,t,F,N,n,_,I,k,S,R,O,r,w,P,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var e=G.Component,L=G.d,U=G.tools,T=BW.sys,j=BW.CONF,C=G.Shell,i=function(B){function e(t){var e,a,r,o,l,s,c,C,u,d,f,p,m,b,y,v,w,n,g,T,E,i,D=B.call(this,t)||this;D.isRfid=!1,D.btnsLinkName=[],D.ajax=new F.BwRule.Ajax,D._lookUpData={},D.aggregate=(a=e=null,{get:function(t){(null!==e||Array.isArray(D.ui.aggrList)&&D.ui.aggrList[0]&&(e=h("div",{className:"aggr-wrapper"}),L.before(D.ftable.wrapper,e),1))&&(t&&(a=t),e.innerHTML="",D.ui.aggrList.forEach(function(n){var i=h("span",null,n.caption,":");L.append(e,i),F.BwRule.Ajax.fetch(j.siteUrl+F.BwRule.reqAddr(n.dataAddr,a)).then(function(t){var e=t.response,a=U.keysVal(e,"data",0,U.keysVal(e,"meta",0));i.innerHTML=n.caption+":"+(a||0)+" &nbsp;&nbsp;"})}))}}),D.filter=(o=r=null,l=function(){var t=o.dataGet();D.ftable.filter.set(t.params),r.isShow=!1},s=function(){D.ftable.filter.clear()},c=function(){var e=[];return D.ftable&&D.ftable.columns.forEach(function(t){e.push({name:t.name,title:t.title,isNumber:t.isNumber,content:t.content})}),e},{init:function(){if(null===o){var a=U.isMb?h("div",{className:"mui-content"},h("ul",{className:"mui-table-view","data-query-name":"local"}),h("div",{"data-action":"add","data-name":"local",className:"mui-btn mui-btn-block mui-btn-primary"},h("span",{className:"mui-icon mui-icon-plusempty"})," 添加条件")):h("form",{className:"filter-form","data-query-name":"local"},h("span",{"data-action":"add",className:"iconfont blue icon-jiahao"}));r=new S.Modal({container:L.closest(D.wrapper,".page-container"),header:"本地过滤",body:a,position:U.isMb?"full":"",width:"730px",isShow:!0,className:"local queryBuilder",zIndex:1003}),U.isMb?(r.modalHeader.rightPanel=(e=new I.InputBox,n=new k.Button({content:"清除",onClick:function(){s(),r.isShow=!1}}),i=new k.Button({icon:"sousuo",onClick:l}),e.addItem(n),e.addItem(i),e),L.on(a,"click",'[data-action="add"]',function(){o.rowAdd();var t=this.previousElementSibling;t.scrollTop=t.scrollHeight})):r.footer={rightPanel:(t=new I.InputBox,t.addItem(new k.Button({content:"取消",type:"default",key:"cancelBtn",onClick:function(){r.isShow=!1}})),t.addItem(new k.Button({content:"清除",type:"default",key:"clearBtn",onClick:function(){s(),r.isShow=!1}})),t.addItem(new k.Button({content:"查询",type:"primary",onClick:l,key:"queryBtn"})),t)},x(["QueryBuilder"],function(t){var e;o=new t.QueryBuilder({queryConfigs:(e=c(),e.map(function(t){return{caption:t.title,field_name:t.name,dynamic:0,link:"",type:"",atrrs:t.content}})),resultDom:U.isMb?L.query("ul.mui-table-view",a):a,setting:null})})}else r&&(r.isShow=!0);var t,e,n,i}}),D.countElements={},D.OLD_DIFFAMOUNT=0,D.multiImgEdit=(C=function(t,e,a){return void 0===a&&(a=!0),h("div",{className:"img"},a?h("div",{className:"appcommon app-guanbi1 img-close","data-md5":e}):"",h("img",{src:t}))},{show:function(r,n){var t,e=D.cols.filter(function(t){return t.name===r})[0],a=D.ftable,i=a.rowGet(n),o=a.columnGet(r),l=a.tableData.rowDataGet(n),s=[],c=l[r],u=D.editParam,d=(u&&u[u.updateType]||[]).some(function(t){return r===t.varName}),f=null;if(c&&"string"==typeof c&&(s=c.split(",")),(!e.atrrs||"22"===e.atrrs.dataType)&&(U.isNotEmpty(s)||U.isEmpty(s)&&d)){var p=!!i&&-1<a.edit.addIndex.get().indexOf(i.data[_.TableBase.GUID_INDEX]),m=D.tableModule.edit.rowCanInit(i,D.isSub),b=D.tableModule.edit.cellCanInit(o,p?1:0);d=d&&m&&b;var y,v,w=h("div",{className:"table-img-wrapper"},y=h("div",{className:"table-img-wrapper-btns"}),v=h("div",{className:"table-img"},s.map(function(t){return C(F.BwRule.fileUrlGet(t,r),t,d)})));new S.Modal({header:"图片查看",top:80,body:w,height:"80%",width:U.isMb?void 0:"70%",position:"down",isDrag:!0,isOnceDestroy:!0,className:"modal-img",onClose:function(){L.off(w,"click",".img .img-close",f),t&&t.destroy()}});var g=function(a){var t=D.tableModule;t&&(D.ftable.editing?Promise.resolve():t.editBtns.start()).then(function(){var t,e=D.ftable.rowGet(n);e&&(e.data=Object.assign(e.data,((t={})[r]=a.join(","),t)))})};if(d){var T=h("div",{className:"table-img-uploader"});L.append(y,T),t=new O.default({nameField:r,container:T,text:"添加图片",accept:{title:"图片",extensions:"jpg,png,gif",mimeTypes:"image/*"},uploadUrl:j.ajaxUrl.fileUpload,showNameOnComplete:!1,onComplete:function(t,e){var a=t.data,n=[];for(var i in a)n.unshift(a[i].value);s=n.concat(s),n.forEach(function(t){L.prepend(v,C(F.BwRule.fileUrlGet(t,r),t,d))}),g(s)}}),L.on(w,"click",".img .img-close",f=function(){var e=this.dataset.md5;s=s.filter(function(t){return t!==e}),L.remove(this.parentElement),g(s)})}}}}),D.imgEdit=(m=[],b=[],y=null,v=-1,w=function(){var a=document.createDocumentFragment();m.forEach(function(t,e){L.append(a,n(t,e))}),b=L.queryAll("img",a),y=new S.Modal({header:"图片查看",top:80,body:a,height:"70%",position:"down"})},n=function(t,e){var r=t.name,a=h("div",{className:"table-img-wrapper","data-field":r},h("div",{className:"table-img-wrapper-btns"}),h("div",{className:"table-img"},h("img",{"data-index":e,style:"max-height:500px;max-width:700px"})));if(!f&&!d)return a;var n=L.query(".table-img-wrapper-btns",a),o=L.query("img",a);if(f){var i=h("div",{className:"table-img-uploader"});L.append(n,i),new O.default({nameField:r,thumbField:u,container:i,text:"选择图片",accept:{title:"图片",extensions:"jpg,png,gif",mimeTypes:"image/*"},uploadUrl:j.ajaxUrl.fileUpload,showNameOnComplete:!1,onComplete:function(t,e){var a=t.data,n={};for(var i in a)n[a[i].key]=a[i].value;o.src=g(n[r]),U.isFunction(p)&&p(n)}})}return d&&new k.Button({content:"删除图片",container:n,onClick:function(){var t;o.src="",U.isFunction(p)&&p(((t={})[r]="",t))}}),a},g=function(t){return U.url.addObj(j.ajaxUrl.fileDownload,{md5_field:"FILE_ID",file_id:t,down:"allow"})},{showImg:function(t){var e=D.ui.pictureAddrList;if(U.isNotEmptyArray(e)){y||function(){D.cols.forEach(function(t){t.atrrs&&"20"===t.atrrs.dataType&&(t.noShow?m.push(t):u=t.name)});var t=D.editParam,e=m.map(function(t){return t.name}),a=t&&t[t.deleteType]||[],n=t&&t[t.updateType]||[];d=a.some(function(t){return e.includes(t.varName)}),f=n.some(function(t){return e.includes(t.varName)}),p=function(e){D.tableModule&&D.tableModule.editBtns.start().then(function(){var t=D.ftable.rowGet(v);t.data=Object.assign(t.data,e)})},w()}();var a=D.ftable.tableData.rowDataGet(t),n=[];m.forEach(function(t){n.push(a[t.name])});var i=e.map(function(t){return U.url.addObj(j.siteUrl+F.BwRule.reqAddr(t,a),D.ajaxData)});b.forEach(function(t,e){t.src=n[e]?g(n[e]):i[e]})}v=t,y&&(y.isShow=!0)},destroy:function(){y&&y.destroy(),y=p=b=m=null}}),D.subBtns=(i=E=T=null,{init:function(t){var e=D.ui.subButtons;E=D.ftable,T&&T.destroy(),T=new I.InputBox({container:t,isResponsive:!U.isMb,className:U.isMb?"":"more-btns"}),Array.isArray(e)&&e.forEach(function(t){var m=new k.Button({icon:t.icon,content:t.title,isDisabled:!(0===t.multiselect||2===t.multiselect&&t.selectionFlag),data:t,onClick:function(){if(-1<m.data.openType.indexOf("rfid"))R.InventoryBtn(m,D);else if(-1<m.data.openType.indexOf("flow")){var t=m.data,e=t.multiselect,a=t.selectionFlag,n=2===e&&a?E.unselectedRowsData:E.selectedRowsData,i=1===e?n[0]:n,r=BW.CONF.siteUrl+t.actionAddr.dataAddr,o=t.actionAddr.varList;U.isNotEmpty(o)&&o.forEach(function(t,e){var a=t.varName;for(var n in i)n===a&&(r=(r+=0===e?"?":"&")+n.toLowerCase()+"="+i[n])})}else{var l=m.data,s=(e=l.multiselect,a=l.selectionFlag,n=2===e&&a?E.unselectedRowsData:E.selectedRowsData,1===e?n[0]:n),c=E.tableData.data;if(l.haveRoll){var u=l.actionAddr.varList,d=0,f=[];c.forEach(function(a,t){var n={};u.forEach(function(t){var e=t.varName;n[e]=a[e]}),f.push(n),U.obj.isEqual(s,a)&&(d=t)}),window.localStorage.setItem("currentKeyField",d+""),window.localStorage.setItem("nextKeyField",JSON.stringify(f));var p=setInterval(function(){var t=window.localStorage.getItem("nextKeyField");U.isNotEmpty(t)&&(clearInterval(p),P.ButtonAction.get().clickHandle(l,s,function(t){},D.pageUrl,D.ui.itemId))},50)}else window.localStorage.removeItem("nextKeyField"),window.localStorage.removeItem("currentKeyField"),P.ButtonAction.get().clickHandle(l,s,function(t){},D.pageUrl,D.ui.itemId)}}});T.addItem(m)}),D.ftable.off(N.FastTable.EVT_SELECTED,i),D.ftable.on(N.FastTable.EVT_SELECTED,i=function(){var n=E.selectedRows.length,i=E.rows.length;T.children.forEach(function(t){var e=t.data.selectionFlag,a=t.data.selectionFlag?i-n:n;t.isDisabled=0===a?!e&&0<t.data.multiselect:1!==n&&2!==t.data.multiselect})})},get box(){return T}}),D.isSub=!!t.isSub,D.editParam=t.editParam,D.tableModule=t.tableModule,F.BwRule.beforeHandle.table(t.ui);var A=D.ui=t.ui;D.isPivot="P"===A.relateType,D.isDrill=["web","webdrill","drill"].includes(A.uiType),D.isRfid=U.isNotEmpty(A.rfidCols)||Array.isArray(A.subButtons)&&A.subButtons.some(function(t){return 0<=t.openType.indexOf("rfid")}),D.hasQuery=A.querier&&[3,13].includes(A.querier.queryType),D.fieldsInit(A.cols);var M=A.subButtons;return D.btnsLinkName=Array.isArray(M)?M.filter(function(t){return t.linkName}).map(function(t){return t.linkName}):[],A.isAsyn&&(t.ajaxData=t.ajaxData||{},t.ajaxData.uiurl=D.pageUrl.substring(function(t,e,a){for(var n=t.indexOf(e),i=0;i<a;i++)n=t.indexOf(e,n+1);return n}(D.pageUrl,"/",5),D.pageUrl.length)),D.isPivot?D.pivotInit(t.ajaxData):D.ftableInit(t.ajaxData),D}return __extends(e,B),e.prototype.wrapperInit=function(t){return h("div",{className:"table-module-wrapper"})},Object.defineProperty(e.prototype,"baseFtablePara",{get:function(){var i=this;return{isWrapLine:U.isMb&&!!this.ui.cols&&this.ui.cols.some(function(t){return 0<t.atrrs.displayWidth}),tabIndex:!0,cols:null,container:this.wrapper,pseudo:{type:"number",multi:U.isNotEmpty(this.ui.multiValue)?this.ui.multiValue:U.isMb},sort:!0,maxHeight:this.isDrill?400:void 0,maxWidth:200,dragSelect:U.isPc,dragCol:!this.isPivot&&U.isPc,clickSelect:!0,isResizeCol:U.isPc,colCount:this.isDrill,btn:U.isMb&&this.isDrill?{name:null,isReplaceTable:this.isDrill}:{name:[this.isRfid?null:"search","statistic","export"],type:U.isMb?"dropdown":"button",target:U.isMb?L.query('[data-target="popover"]>[data-action="down-menu"]'):void 0,isReplaceTable:this.isDrill},cellFormat:function(t,e){var a=e.column,n=i.ftable.tableData.rowDataGet(e.row.index);return a?i.cellFormat(a.content,t,n):{text:t}},rowFormat:function(r){var o="",l="";return["GRIDBACKCOLOR","GRIDFORECOLOR"].forEach(function(t,e){var a=r[t];if(a){var n=U.val2RGB(a),i="rgb("+n.r+","+n.g+","+n.b+")";0===e?l=i:o=i}}),{color:o,bgColor:l,attr:{}}},page:0===this.ui.multPage?null:{size:50,options:[50,100,500]},menu:[this.isPivot?null:{colMulti:1,title:"锁定/解锁列",onClick:function(t){var e=t.column.isFixed;t.column.isFixed=!e,S.Modal.toast(e?"已解锁":"已锁定")}},{title:"复制单元格",onClick:function(t){T.window.copy(t.text)}},{title:"复制行",onClick:function(t,e,a){a[0]&&T.window.copy(e.map(function(t){return t.cells.map(function(t){return t.text}).join("\t")}).join("\r\n"))}},{colMulti:1,title:"复制列",onClick:function(t,e,a){var n=a[0];if(n){var i=n.cells[0].concat(n.cells[1]).map(function(t){return t.text}).join("\r\n");T.window.copy(i)}}},{rowMulti:1,title:"列复制",children:this.cols.filter(function(t){return!t.noShow}).map(function(e){return{title:e.title,onClick:function(t){T.window.copy(t.frow.data[e.name])}}})},U.isMb?{title:"列排序",onClick:function(){i.ftable.colsSort.open()}}:null]}},enumerable:!0,configurable:!0}),e.prototype.ftableInit=function(t){var l=this,s=this.ui;this.ftable=new n.FastBtnTable(Object.assign(this.baseFtablePara,{cols:this.colParaGet(this._cols),ajax:{ajaxData:t,once:1!==s.multPage,auto:!this.hasQuery,fun:function(t){var e=t.pageSize,a=t.current,n=t.sort,i=t.custom,r=j.siteUrl+F.BwRule.reqAddr(s.dataAddr);e=-1===e?3e3:e;var o=Array.isArray(n)?JSON.stringify(n.map(function(t){return t[0]+","+t[1].toLocaleLowerCase()})):"";return Promise.all([l.ajax.fetch(r,{needGps:s.dataAddr.needGps,timeout:3e4,data:Object.assign({pageparams:'{"index"='+(a+1)+',"size"='+e+',"total"=1}',pagesortparams:o},i)}),l.lookup]).then(function(t){var e=t[0].response,a=e.data,n=e.head;if(l.sectionField(e),a){var i=l.editParam;if(i){var r=[];["insert","update","delete"].forEach(function(t){var e=-1<["update","delete"].indexOf(i[t+"Type"]),a=i[t];e&&Array.isArray(a)&&(r=r.concat(a))}),F.BwRule.addOldField(F.BwRule.getOldField(r),a)}}return{data:a,total:n?n.totalNum:0}})}}})),!this.isDrill&&this.ftable.btnAdd("filter",{type:"default",icon:"sousuo",content:"本地过滤",onClick:function(){l.filter.init()}},1),1==this.ui.rfidFlag&&this.ftable.btnAdd("rfid",{type:"default",content:"rfid设置",onClick:function(){x(["RfidSetting"],function(t){new t.RfidSettingModal})}}),this.ftableReady(),this.ftable.on(N.FastTable.EVT_TABLE_COL_CHANGE,function(t){U.isNotEmpty(l.ui.settingId)&&F.BwRule.Ajax.fetch(j.siteAppVerUrl+"/setting/"+l.ui.settingId,{type:"put",data2url:!0,data:{columnorderparam:JSON.stringify(t.data)}}).then(function(){S.Modal.toast("修改成功")}).catch(function(t){S.Modal.toast("修改失败")})})},Object.defineProperty(e.prototype,"onFtableReady",{set:function(t){this.isFtableReady?U.isFunction(t)&&t():this._ftableReadyHandler=t},enumerable:!0,configurable:!0}),e.prototype.ftableReady=function(){var t=this;this.clickInit(),this.aggregate.get(this.ajaxData),this.rfidColInit(),this.reportCaptionInit(),U.isPc&&setTimeout(function(){t.ui.inputs&&new a.Inputs({inputs:t.ui.inputs,container:t.wrapper,table:t.ftable})},200),U.isFunction(this._ftableReadyHandler)&&this._ftableReadyHandler(),this.isFtableReady=!0,this.trigger(e.EVT_READY)},e.prototype.colParaGet=function(t){var n=t.some(function(t){return U.isNotEmpty(t.subcols)}),i=[[]],r=0;return t.forEach(function(t){t.noShow||r++;var e=t.subcols,a=n&&Array.isArray(e)&&e[0];i[0].push({title:t.caption,name:t.name,content:t,isFixed:1===r,isNumber:F.BwRule.isNumber(t.atrrs&&t.atrrs.dataType),isVirtual:t.noShow,colspan:a?e.length:1,rowspan:n&&!a?2:1,maxWidth:t.atrrs&&(t.atrrs.displayWidth?6*t.atrrs.displayWidth:void 0)}),a&&(i[1]=i[1]||[],e.forEach(function(t){i[1].push({title:t.caption,name:t.name,content:t,isVirtual:t.noShow,colspan:1,rowspan:1})}))}),i},e.prototype.pivotInit=function(t){var i=this;void 0===t&&(t={});var e=new r.Loading({msg:"加载中...",container:this.wrapper});this.ajax.fetch(j.siteUrl+F.BwRule.reqAddr(this.ui.dataAddr),{data:Object.assign({},t,{pageparams:'{"index"=1,"size"=3000,"total"=1}'})}).then(function(t){var e=t.response;U.isEmpty(e)||(i.ftable=new n.FastBtnTable(Object.assign(i.baseFtablePara,{cols:a(e.meta),data:e.data})),i.ftableReady())}).finally(function(){e.destroy(),e=null});var a=function(t){var l=i._cols,s=F.BwRule.getCrossTableCols(t,l).cols,a=[],n=[];s.forEach(function(t){var e=~t.title.indexOf(".");e&&~t.name.indexOf("小计")||!e?a.push(t):n.push(t)}),s=a.concat(n);var c=[[],[]],u={name:"",count:1};return s.forEach(function(t,e){var a=t.name.split("."),n=a[0],i=a[1],r=(s[e+1]||{name:""}).name.split(".")[0];if(n!==r){var o=l.filter(function(t){return t.name===n})[0];c[0].push({title:o?o.caption:n,name:o?o.name:n,isFixed:!c[0],colspan:i?u.count:1,rowspan:i?1:2,content:i?void 0:t,isNumber:i?void 0:F.BwRule.isNumber(t.atrrs&&t.atrrs.dataType),isVirtual:i?void 0:t.noShow}),u={name:r,count:1}}else u.count++;i&&c[1].push({title:t.caption,name:t.name,content:t,isNumber:F.BwRule.isNumber(t.atrrs&&t.atrrs.dataType),isVirtual:t.noShow,colspan:1,rowspan:1})}),c}},e.prototype.sectionField=function(t){var a=t.meta,e=this.ajaxData,n=e.queryoptionsparam&&JSON.parse(e.queryoptionsparam);if(n&&n.sectionParams&&n.sectionParams.sectionField){var i=n.sectionParams.sectionField,r="";if(i!==this._sectionField){for(var o=0,l=this.ui.cols;o<l.length;o++){var s=l[o];s.name===i&&(r=s.caption)}var c=r+"段",u=this.ftable.columnGet("分段");u?u.title=c:this.ftable.columnAdd({title:c,name:"分段"},void 0,0),this._sectionField=i}}else this._sectionField&&this.ftable.columnDel("分段"),this._sectionField="";U.isNotEmpty(t.data)&&this.ftable.columns.forEach(function(t){var e=t.content||{};t.show="lookup"===e.elementType||a.includes(t.name)})},Object.defineProperty(e.prototype,"lookUpData",{get:function(){return this._lookUpData||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lookup",{get:function(){var a=this;if(U.isEmpty(this._lookUpData)){var t=this.cols.filter(function(t){return"lookup"===t.elementType}).map(function(e){return F.BwRule.getLookUpOpts(e).then(function(t){a._lookUpData=a._lookUpData||{},a._lookUpData[e.name]=t})});return Promise.all(t).then(function(){})}return Promise.resolve()},enumerable:!0,configurable:!0}),e.prototype.tdClickHandler=function(t,e){if(t){var a=t.link;if(!a||t.endField&&1!==e[t.endField]){var n=o(t,e,this.ui.keyField);n&&T.window.open({url:n})}else F.BwRule.link({link:a.dataAddr,varList:a.varList,dataType:t.atrrs.dataType,data:e,needGps:1===a.needGps})}},e.prototype.clickInit=function(){var r=this.ftable,t=".section-inner-wrapper:not(.pseudo-table) tbody",e=t+" td",o=this;r.click.add(e+":not(.cell-img)",function(t){if(!(t.altKey||t.ctrlKey||t.shiftKey)){var e=parseInt(this.parentNode.dataset.index),a=this.dataset.name,n=r.columnGet(a).content,i=r.rowGet(e).data;n&&o.tdClickHandler(n,i)}});var a=function(t){if(!(t.altKey||t.ctrlKey||t.shiftKey)){var e="TD"===this.tagName,a=parseInt(e?this.parentElement.dataset.index:this.dataset.index),n=this.dataset.name;e&&o.cols.some(function(t){return t.name===n&&"22"===t.atrrs.dataType})?o.multiImgEdit.show(n,a):o.imgEdit.showImg(a)}};this.cols.some(function(t){var e=t.atrrs&&t.atrrs.dataType;return!t.noShow&&[F.BwRule.DT_IMAGE,F.BwRule.DT_MUL_IMAGE].includes(e)})?L.on(r.wrapper,"click",e+".cell-img:not(.disabled-cell)",U.pattern.throttling(a,1e3)):r.click.add(".section-inner-wrapper:not(.pseudo-table) tbody tr",U.pattern.throttling(a,1e3))},Object.defineProperty(e.prototype,"ajaxData",{get:function(){return this.ftable.tableData.ajaxData},enumerable:!0,configurable:!0}),e.prototype.refresh=function(t){var e=this;return this.ftable.tableData.refresh(t).then(function(){e.aggregate.get(t)})},Object.defineProperty(e.prototype,"pageUrl",{get:function(){if(!this._pageUrl)if(T.isMb)this._pageUrl=location.href;else{var t=L.closest(this.wrapper,".page-container[data-src]");this.pageContainer=t,this._pageUrl=t?t.dataset.src:""}return this._pageUrl},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rowDefData",{get:function(){var i=this;return new Promise(function(t,e){if(U.isNotEmpty(i._rowDefData))t(i._rowDefData);else{var a=F.BwRule.getDefaultByFields(i.cols),n=i.ui.defDataAddrList;U.isNotEmpty(n)?Promise.all(n.map(function(t){return F.BwRule.Ajax.fetch(j.siteUrl+F.BwRule.reqAddr(t)).then(function(t){var e=t.response;a=Object.assign(a,e.data[0]||{})})})).then(function(){i._rowDefData=a,t(a)}).catch(function(){e()}):(i._rowDefData=a,t(a))}})},enumerable:!0,configurable:!0}),e.prototype.fieldsInit=function(t){this._cols=t.map(function(t){var e=Object.assign({},t);F.BwRule.NoShowFields.includes(e.name)&&(e.noShow=!0);var a=e.atrrs;return a&&(a.dataType!==F.BwRule.DT_DATETIME||a.displayFormat||(a.displayFormat="yyyy-MM-dd HH:mm:ss"),a.dataType!==F.BwRule.DT_TIME||a.displayFormat||(a.displayFormat="HH:mm:ss")),e})},Object.defineProperty(e.prototype,"cols",{get:function(){var a=[];return this._cols.forEach(function(t){!function e(t){U.isEmpty(t.subcols)?a.push(t):t.subcols.forEach(function(t){e(t)})}(t)}),a},enumerable:!0,configurable:!0}),e.prototype.reportCaptionInit=function(){var t=this.ui.reportTitle;t&&L.prepend(this.wrapper,h("div",{className:"table-module-report"},t))},e.prototype.rfidColthead=function(){var i=this,o=this.ui.rfidCols;if(o.calc){var t=o.calc.cols||{},e=o.calc.when||{},l=this.countElements,a=t.calculate,n=t.calculateScan,r=t.calculateDiff,s=t.calculateAdd,c=o.calc.calcRule||[],u=l[a],d=l[n],f=l[r],p=l[s],m=0;Array.isArray(o.calcData)&&o.calcData.map(function(t){if((o.calc.cols||{}).calculateAdd){var e=o.calc.cols.calculateAdd;t.calcField==e&&(m=parseInt(t.calcValue))}}),C.inventory.columnCountOn(e,1,o.inventoryKey,!1,!1,function(t){var e="object"!=typeof t.data?{}:t.data||{};if(u&&"-1"!==e.Calculate&&(u.innerHTML=void 0===e.Calculate?"0":e.Calculate),d&&"-1"!==e.CalculateScan&&(d.innerHTML=void 0===e.CalculateScan?"0":e.CalculateScan),f&&"-1"!==e.CalculateDiff&&(f.innerHTML="-"+(void 0===e.CalculateDiff?"0":e.CalculateDiff)),p&&"-1"!==e.CalculateAdd){var a=m+parseInt(void 0===e.CalculateAdd?"0":e.CalculateAdd);p.innerHTML=isNaN(a)?"-":a+""}var r={};for(var n in l)r[n]=l[n].innerHTML;void 0===r.SCANAMOUNT&&"-1"==e.CalculateScan&&(r.SCANAMOUNT=void 0===e.Calculate?"0":e.CalculateScan),r.OLD_DIFFAMOUNT=i.OLD_DIFFAMOUNT,o.scanField&&(r[o.scanField.toUpperCase()]=l.scanyet.innerHTML),c.forEach(function(t){var e=t.field,a=t.rule;if(e&&a){var n=U.str.parseTpl(a,r),i=l[e];i&&(i.innerHTML=U.calc(n))}})})}},e.prototype.rfidDownAndUpInitHead=function(){var i=this,o=this.ui.rfidCols;if(o.calc){var t=o.calc.cols||{},e=o.calc.when||{},l=this.countElements,a=t.calculate,n=t.calculateScan,r=t.calculateDiff,s=t.calculateAdd,c=o.calc.calcRule||[],u=l[a],d=l[n],f=l[r],p=l[s],m=0;C.inventory.columnCountOn(e,1,o.inventoryKey,!0,!1,function(t){var e="object"!=typeof t.data?{}:t.data||{};if(Array.isArray(o.calcData)&&o.calcData.map(function(t){if((o.calc.cols||{}).calculateAdd){var e=o.calc.cols.calculateAdd;t.calcField==e&&(m=parseInt(t.calcValue))}}),u&&"-1"!==e.Calculate&&(u.innerHTML=void 0===e.Calculate?"0":e.Calculate),d&&"-1"!==e.CalculateScan&&(d.innerHTML=void 0===e.CalculateScan?"0":e.CalculateScan),f&&"-1"!==e.CalculateDiff&&(f.innerHTML="-"+(void 0===e.CalculateDiff?"0":e.CalculateDiff)),p&&"-1"!==e.CalculateAdd){var a=m+parseInt(void 0===e.CalculateAdd?"0":e.CalculateAdd);p.innerHTML=a+""}var r={};for(var n in l)r[n]=l[n].innerHTML;void 0===r.SCANAMOUNT&&"-1"!==e.CalculateScan&&(r.SCANAMOUNT=void 0===e.Calculate?"0":e.CalculateScan),r.OLD_DIFFAMOUNT=i.OLD_DIFFAMOUNT,o.scanField&&(r[o.scanField.toUpperCase()]=l.scanyet.innerHTML),c.forEach(function(t){var e=t.field,a=t.rule;if(e&&a){var n=U.str.parseTpl(a,r),i=l[e];i&&(i.innerHTML=U.calc(n))}}),C.inventory.columnCountOff({},1,o.inventoryKey,function(t){})})}},e.prototype.rfidColInit=function(){var i=this,n=this.ui.rfidCols,t=this.ftable;this.ui.cols;if(U.os.android&&this.isRfid&&n&&n.amountFlag){this.ui.subButtons&&this.ui.subButtons.forEach(function(t,e){"rfid_down"===t.openType?t.title=t.title+"下载":"rfid_up"===t.openType&&(t.title=t.title+"上传")}),C.inventory.canRfid&&this.isRfid&&this.ui.subButtons.some(function(t){return"rfid_begin"===t.openType})&&(T.window.closeConfirm={condition:function(){return new Promise(function(e,t){C.inventory.columnCountOn(n.calc.when,1,n.inventoryKey,!0,!0,function(t){e(!!(t.data&&t.data.CalculateAdd&&0<t.data.CalculateAdd))})})},msg:"有未上传的数据, 是否确认要退出？",btn:["确定","取消"]});var e=h("div",{className:"table-module-amount"},Array.isArray(n.calcData)&&n.calcData.map(function(t){"DIFFAMOUNT"==t.calcField&&(i.OLD_DIFFAMOUNT=parseInt(t.calcValue));var e=h("span",null,t.calcValue?t.calcValue:0);return i.countElements[t.calcField]=e,h("span",null,t.calcCaption,":",e)}));if(n.scanFieldName){var a=h("span",null,"0");this.countElements.scanyet=a;var r=h("span",null,"已扫描量:",a);L.append(e,r),n.amount&&C.inventory.getScanCount(n.amount.toUpperCase(),function(t){i.countElements.scanyet.innerHTML=t.data.SCANAMOUNTS||"0"})}if(t.on(N.FastTable.EVT_RENDERED,function(){i.ui.subButtons;if(n.inventoryKey&&n.classify){var a=t.columnGet(n.classify.toUpperCase());C.inventory.getData(n.inventoryKey,n.classify.toUpperCase(),function(t){var r=t.data,e=a.data.map(function(t){for(var e=0,a=0,n=r;a<n.length;a++){var i=n[a];if(i.field==t){e=i.count;break}}return{field:t,count:e}});R.ontimeRefresh(e,i,n)})}}),L.classAdd(this.wrapper,"has-amount"),n.calcData&&L.prepend(this.wrapper,e),U.isNotEmpty(n.calc)){var o=n.calc.cols||{},l=n.calc.when||{},s=this.countElements,c=o.calculate,u=o.calculateScan,d=o.calculateDiff,f=o.calculateAdd,p=n.calc.calcRule||[],m=s[c],b=s[u],y=s[d],v=s[f],w=0;Array.isArray(n.calcData)&&n.calcData.map(function(t){if((n.calc.cols||{}).calculateAdd){var e=n.calc.cols.calculateAdd;t.calcField==e&&(w=parseInt(t.calcValue))}});var g=n.inventoryKey?n.inventoryKey:"key";U.isNotEmpty(n.calc)&&C.inventory.columnCountOn(l,1,g,!0,!1,function(t){var e="object"!=typeof t.data?{}:t.data||{};if(U.isEmpty(e))C.inventory.columnCountOff({},1,g,function(){});else{if(m&&"-1"!==e.Calculate&&(m.innerHTML=void 0===e.Calculate?"0":e.Calculate),b&&"-1"!==e.CalculateScan&&(b.innerHTML=void 0===e.CalculateScan?"0":e.CalculateScan),y&&"-1"!==e.CalculateDiff&&(y.innerHTML="-"+(void 0===e.CalculateDiff?"0":e.CalculateDiff)),v&&"-1"!==e.CalculateAdd){var a=w+parseInt(void 0===e.CalculateAdd?"0":e.CalculateAdd);v.innerHTML=isNaN(a)?"-":a+""}var r={};for(var n in s)r[n]=s[n].innerHTML;void 0===r.SCANAMOUNT&&"-1"!==e.CalculateScan&&(r.SCANAMOUNT=void 0===e.Calculate?"0":e.CalculateScan),r.OLD_DIFFAMOUNT=i.OLD_DIFFAMOUNT,p.forEach(function(t){var e=t.field,a=t.rule;if(e&&a){var n=U.str.parseTpl(a,r),i=s[e];i&&(i.innerHTML=U.calc(n))}}),C.inventory.columnCountOff(l,1,g,function(t){})}})}}},e.prototype.cellFormat=function(i,t,r){var o,l=this,e=t,s=[];if(i&&!i.noShow&&i.atrrs){var a=i.atrrs.dataType,n=a===F.BwRule.DT_IMAGE;if(n&&i.link){var c=U.url.addObj(j.siteUrl+F.BwRule.reqAddr(i.link,r),this.ajaxData);e=h("img",{src:c}),s.push("cell-img")}else if(a===F.BwRule.DT_MUL_IMAGE){if("string"==typeof t&&t[0]){var u=t.split(",").map(function(t){return F.BwRule.fileUrlGet(t,i.name,!0)}).filter(function(t){return t});U.isNotEmptyArray(u)&&(e=new w.LayoutImage({urls:u}).wrapper)}s.push("cell-img")}else if("50"===a)e=h("div",{className:"appcommon "+(1===t?"app-xuanzhong":"app-guanbi1"),style:"color: "+(1===t?"green":"red")});else if("STDCOLORVALUE"===i.name){var d=U.val2RGB(t),f=d.r,p=d.g,m=d.b;e=h("div",{style:"backgroundColor: rgb("+f+","+p+","+m+")",height:"100%"})}else if("lookup"===i.elementType)for(var b=0,y=this.lookUpData[i.name]||[];b<y.length;b++){var v=y[b];v.value==r[i.lookUpKeyField]&&(e=v.text)}else e=F.BwRule.formatTableText(t,i);t&&F.BwRule.isTime(a)&&(e=F.BwRule.strDateFormat(t,i.atrrs.displayFormat)),F.BwRule.isNumber(a)&&s.push("text-right"),["drillAddr","webDrillAddr","webDrillAddrWithNull"].forEach(function(t,e){var a=i[t],n=r[l.ui.keyField];a&&a.dataAddr&&(2===e?U.isEmpty(n):U.isNotEmpty(n))&&(o="blue",s.push("cell-link"))}),!i.link||n||i.endField&&1!==r[i.endField]||(o="blue",s.push("cell-link")),this.btnsLinkName.includes(i.name)&&(s.push("cell-link"),o="blue")}return{text:e,classes:s,bgColor:void 0,color:o}},e.prototype.destroy=function(){B.prototype.destroy.call(this),this.ftable.destroy(),this.imgEdit.destroy(),this.ftable=null,this.multiImgEdit=null,this.imgEdit=null,this._ftableReadyHandler=null},e.EVT_READY="__TABLE_READY__",e}(e);function o(t,e,a){for(var n,i=0,r=["drillAddr","webDrillAddr","webDrillAddrWithNull"];i<r.length;i++){var o=r[i],l=t[o];if(n=l&&l.dataAddr?F.BwRule[o](l,e,a):"")break}return n?j.siteUrl+n:""}t.BwTableModule=i,t.drillUrlGet=o}),define("BwMainTableModule",["require","exports","BwTableModule","Spinner"],function(l,t,e,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=G.tools,n=G.d,i=function(o){function t(t){var e=o.call(this,t)||this;return e.para=t,n.classAdd(e.wrapper,"table-module-main"),e}return __extends(t,o),t.prototype.ftableReady=function(){o.prototype.ftableReady.call(this),this.tableHeightInit(),a.isMb||this.ui.printList&&0<this.ui.printList.length&&(this.initLabelPrint(),this.initFormPrint())},t.prototype.tdClickHandler=function(t,e){if(o.prototype.tdClickHandler.call(this,t,e),t){var a=t.name;if(this.btnsLinkName.includes(a))for(var n=function(t){var e=t.data;e&&e.linkName&&e.linkName===a&&setTimeout(function(){t.onClick.call(t,null)},100)},i=0,r=this.subBtns.box&&this.subBtns.box.children||[];i<r.length;i++){n(r[i])}}},t.prototype.clickInit=function(){o.prototype.clickInit.call(this);this.ftable},t.prototype.tableHeightInit=function(){var t=this.ui,e=document.body.clientHeight;a.isMb&&((a.isNotEmpty(t.subButtons)||a.isNotEmpty(this.editParam))&&(e-=37),t.rfidCols&&t.rfidCols.amountFlag&&(e-=42),t.reportTitle&&(e-=42),e-=45,CSS&&CSS.supports&&CSS.supports("height: env(safe-area-inset-bottom)")?this.ftable.wrapper.style.height="calc("+e+"px - env(safe-area-inset-bottom) - env(safe-area-inset-bottom))":this.ftable.wrapper.style.height=e+"px")},t.prototype.initFormPrint=function(){var a,n=this,t=!0;this.ftable.btnAdd("formPrint",{content:"报表打印",icon:"label",onClick:function(){if(t){t=!1;var e=new s.Spinner({el:n.ftable.btnGet("formPrint").wrapper,size:14,type:s.Spinner.SHOW_TYPE.replace});e.show(),l(["FormPrintModule"],function(t){a=new t({container:n.wrapper,cols:n.ftable.dataTools.getCols(),middleTable:n.ftable.mainTable.head.wrapper,tableData:function(){return n.ftable.data}}),e.hide()})}else a.modal.isShow=!0}},1)},t.prototype.initLabelPrint=function(n){var i,r=this,t=!0;this.ftable.btnAdd("labelPrint",{content:"标签打印",icon:"label",onClick:function(){if(t){t=!1;var a=new s.Spinner({el:r.ftable.btnGet("labelPrint").wrapper,size:14,type:s.Spinner.SHOW_TYPE.replace});a.show(),l(["LabelPrintModule"],function(t){var e=[];r.ftable.columnsVisible.forEach(function(t){t.content&&"11"===t.content.dataType&&e.push(t.name)}),i=new t({moneys:e,printList:r.para.ui.printList,container:r.wrapper,cols:r.ftable.columnsVisible,getData:function(){return r.ftable.data},selectedData:function(){return r.ftable.selectedRowsData},callBack:function(){n&&n()}}),a.hide()})}else i.modal.isShow=!0}},0)},t}(e.BwTableModule);t.BwMainTableModule=i}),define("BwSubTableModule",["require","exports","BwTableModule"],function(t,e,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=G.tools,i=G.d,r=function(a){function t(t){return a.call(this,t)||this}return __extends(t,a),t.prototype.ftableReady=function(){a.prototype.ftableReady.call(this),n.isNotEmpty(this.ui.subButtons)&&this.subBtns.init(this.subBtnWrapper)},Object.defineProperty(t.prototype,"subBtnWrapper",{get:function(){if(!this._subBtnWrapper)if(n.isMb){var t=this.tableModule.mobileModal,e=h("div",{className:"sub-btn-wrapper mui-bar-footer"});t.bodyWrapper.style.height="calc(100% - 39px)",i.after(t.bodyWrapper,e),this._subBtnWrapper=e}else this._subBtnWrapper=this.ftable.btnWrapper;return this._subBtnWrapper},enumerable:!0,configurable:!0}),t.prototype.wrapperInit=function(t){var e=a.prototype.wrapperInit.call(this,t);return i.classAdd(e,"table-module-sub"),e},t}(a.BwTableModule);e.BwSubTableModule=r}),define("newTableModule",["require","exports","BwRule","BwMainTableModule","FastTable","BwSubTableModule","Modal","MbPage","CheckBox","InputBox","Button","Loading","FormCom"],function(S,t,R,O,P,o,L,l,n,U,j,H,W){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var V=G.d,q=G.tools,K=BW.CONF,e=function(){function k(t){var r,o,e,l,s,i,a,n,c,u,d,f,p,m,b,h,y,v,w,g,T,C,E,D,A,M,B=this;this.main=null,this.sub=null,this.subIndex=0,this.mobileModal=null,this.subWrapper=null,this.draggedEvent=(o=r=0,s=l=e=null,{on:function(){var n=B.main.wrapper,i=B.sub.wrapper;r=n.offsetHeight,o=i.offsetHeight,V.on(B.main.container,"mousedown",".drag-line",e=function(t){document.body.style.cssText="cursor: n-resize!important";var a=t.clientY;V.off(document,"mousemove",l),V.off(document,"mouseup",s),V.on(document,"mousemove",l=function(t){var e=t.clientY-a;200<r+e&&200<o-e&&(a=t.clientY,r+=e,o-=e,n.style.height=r+"px",i.style.height=o+"px")}),V.on(document,"mouseup",s=function(){V.off(document,"mousemove",l),V.off(document,"mouseup",s),document.body.style.removeProperty("cursor")})})},off:function(){V.off(B.dragLine,"mousedown",e)}}),this.editBtns=(c=[],u=function(){return p.start(),B.edit.start()},a=".section-inner-wrapper:not(.pseudo-table) tbody td:not(.cell-img)",n=function(){var t=this;u().then(function(){t.click()})},d={on:function(){V.on(B.main.container,"dblclick",a,n)},off:function(){V.off(B.main.container,"dblclick",a,n)}},f=function(e,t){var a=B.main.editParam,n=B.sub&&B.sub.editParam;return(void 0===t?[a,n]:[t?a:n]).some(function(t){return function(t,e){if(t)for(var a=0,n=["update","insert","delete"];a<n.length;a++){var i=n[a];if(-1<e.indexOf(t[i+"Type"]))return!0}return!1}(t,e)})},p={end:function(t){var e={edit:f(["update"],t),insert:f(["insert"],t),del:f(["delete"],t),save:!1,cancel:!1};if(i)for(var a in e){var n=i.getItem(a);n&&(n.isDisabled=!e[a])}d.on()},start:function(t){var e={edit:!1,insert:f(["insert"],t),del:f(["delete"],t),save:!0,cancel:!0};for(var a in e){var n=i.getItem(a);n&&(n.isDisabled=!e[a])}d.off()}},{init:function(t){var e;e=t,c=[{key:"edit",content:"编辑",onClick:function(){u()},icon:"app-bianji",iconPre:"appcommon"},{key:"insert",content:"新增",onClick:function(){p.start(),B.edit.insert()},icon:"app-xinzeng",iconPre:"appcommon"},{key:"del",content:"删除",onClick:function(){p.start(),B.edit.del()},icon:"app-shanchu",iconPre:"appcommon"},{key:"save",content:"保存",onClick:function(){B.edit.save()},icon:"app-baocun",iconPre:"appcommon"},{key:"cancel",content:"取消",onClick:function(){p.end(),B.edit.cancel()},icon:"app-quxiao",iconPre:"appcommon"}],i=new U.InputBox({container:e}),V.classAdd(i.wrapper,"pull-left edit-btns"),c.forEach(function(t){i.addItem(new j.Button(t))}),p.end(),B.active.onChange=function(t){B.main.ftable.editing?p.start(t):p.end(t)}},get box(){return i},start:u,end:function(){p.end()}}),this.active=(h=!0,y=function(t){},{on:function(){B.sub&&V.on(B.sub.wrapper,"click",m=function(){h=!1,q.isFunction(y)&&y(h)}),V.on(B.main.wrapper,"click",b=function(){h=!0,q.isFunction(y)&&y(h)})},off:function(){B.sub&&V.off(B.sub.wrapper,"click",m),V.off(B.main.wrapper,"click",b)},get isMain(){return h},set isMain(t){h=t},set onChange(t){y=t}}),this.edit=(v=B,w=null,T=function(){var o=B.main.ftable;if(!o.editing){var a,t=[];return a=function(r){r&&t.push(Promise.all([E(),r.rowDefData]).then(function(t){var e=t[0],a=t[1],n=o.pseudoTable?o.pseudoTable.presentOffset:-1,i=r.isSub&&0<=n?o.tableData.rowDataGet(n):null;C(e,r,Object.assign({},a,i))}))},[B.main,B.sub].forEach(function(t,e){a(t,e)}),Promise.all(t).then(function(){})}},C=function(l,u,t){w=new l({auto:!1,type:"table",fields:u.cols.map(function(t){return{dom:null,field:t}})}),u.ftable.editorInit({defData:t,isPivot:"P"===B.bwEl.relateType,autoInsert:!1,inputInit:function(o,t,e){var a=o.row.index,l=u.ftable.rowGet(a),s=t.content,n=e;if("lookup"===s.elementType){var i=s.lookUpKeyField,r=l.cellGet(i);n=r?r.data:""}var c=R.BwRule.isImage(s.atrrs&&s.atrrs.dataType)?null:w.init(t.name,{dom:o.wrapper,data:l.data,field:s,onExtra:function(t,e,a){if(void 0===a&&(a=!1),q.isEmpty(t)&&a)o.data="";else if("lookup"===s.elementType){var n=s.lookUpKeyField,i=l.cellGet(n);if(i&&i.column){var r=i.column.content;i.data=t[n],r.assignSelectFields&&r.assignAddr&&k.initAssignData(r.assignAddr,l?l.data:{}).then(function(t){var a=t.response.data;a&&a[0]&&r.assignSelectFields.forEach(function(t){var e=l.cellGet(t);e&&(e.data=a[0][t])})})}}}});return c instanceof W.FormCom&&c.set(n),c},cellCanInit:function(t,e){return A(t,e)},rowCanInit:function(t){return M(t,u.isSub)}}),u.ftable.on(P.FastTable.EVT_CELL_EDIT_CANCEL,function(t){e(t)});var e=function(n){var t,e,a=n.name,i=n.column.content,r=n.frow,o=r.data;"lookup"===i.elementType?(t=r.cellGet(i.lookUpKeyField))&&t.column&&(i=t.column.content,e=w.validate.start(t.name,t.data)):e=w.validate.start(a,n.data),e&&e[a]?n.errorMsg=e[a].errMsg:i.chkAddr&&q.isNotEmpty(o[a])?l.checkValue(i,o,function(){n.data=null,t&&(t.data=null)}).then(function(t){var e=t.errors,a=t.okNames;Array.isArray(e)&&e.forEach(function(t){var e=t.name,a=t.msg,n=r.cellGet(e);n&&(n.errorMsg=a)}),Array.isArray(a)&&a.forEach(function(t){n.errorMsg=null})}):n.errorMsg=""}},E=function(){return new Promise(function(e){S(["EditModule"],function(t){e(t.EditModule)})})},D=function(t){var u={param:[]};return[B.main,B.sub].forEach(function(t,e){if(t){var n=t.ftable.editedData;if(1===e){var i=B.main.ftable.edit,a=function(a){q.isNotEmpty(n[a])&&n[a].forEach(function(t,e){n[a][e]=Object.assign({},i,t)})};for(var r in n)a(r)}var o,l,s,c=(o=n,l=t.editParam,s={},l&&["update","delete","insert"].forEach(function(t){var e=l[t+"Type"];if(l[t]&&o[e][0]){var a=R.BwRule.varList(l[t],o[e],!0,"P"!==B.bwEl.relateType);a&&(s[t]=a)}}),q.isEmpty(s)||(s.itemId=l.itemId),s);q.isEmpty(c)||u.param.push(c)}}),u},{start:T,cancel:g=function(){B.main.ftable.editorCancel(),B.sub&&B.sub.ftable.editorCancel()},save:function(){return w.assignPromise.then(function(){var a=D();if(q.isEmpty(a.param))return L.Modal.toast("没有数据改变"),g(),void B.editBtns.end();var n=new H.Loading({msg:"保存中",disableEl:B.main.wrapper});R.BwRule.Ajax.fetch(K.siteUrl+B.bwEl.tableAddr.dataAddr,{type:"POST",data:a}).then(function(t){var e=t.response;R.BwRule.checkValue(e,a,function(){B.refresh(),L.Modal.toast(e.msg),B.editBtns.end(),n&&n.destroy(),n=null,g(),q.event.fire(k.EVT_EDIT_SAVE)})}).finally(function(){n&&n.destroy(),n=null})})},insert:function(){var e=B.main,a=B.sub;(e.ftable.editing?Promise.resolve():T()).then(function(){var t=B.active.isMain?e:a;t&&t.ftable.rowAdd()})},del:function(){var a=B.main,n=B.sub;(a.ftable.editing?Promise.resolve():T()).then(function(){var t=a.ftable,e=n?n.ftable:null;!e||q.isEmpty(e.data)?t.rowDel(t.selectedRows.map(function(t){return t.index})):e&&q.isNotEmpty(e.selectedRows)?e.rowDel(e.selectedRows.map(function(t){return t.index})):L.Modal.alert("不能删除有明细的主表数据")})},cellCanInit:A=function(t,e){var a=t.content||{};return 1===e?!a.noModify:!a.noEdit},rowCanInit:M=function(t,e){var o=function(t,e){if(t)return!(e&&0===e.EDITEXPRESS);var a=v.main.ftable,n=a.pseudoTable.presentOffset,i=a.rowGet(n),r=i?i.data:{};return o(!0,r)};return!q.isEmpty(t)&&o(!e,t.data)}}),console.log(t),this.bwEl=t.bwEl,this._defaultData=t.data||null;var x=this.bwEl.subTableList&&this.bwEl.subTableList[0],F=z(t.bwEl.tableAddr),N=F.mainParam,_=F.subParam;this.editable=!!(N||x&&_);var I=this.main=new O.BwMainTableModule({ui:t.bwEl,container:t.container,editParam:N,ajaxData:t.ajaxData,tableModule:this});I.onFtableReady=function(){if(q.isNotEmpty(B.bwEl.subButtons)&&I.subBtns.init(B.btnWrapper),B.editable&&B.editBtns.init(B.btnWrapper),x){var a=I.ftable,n=a.pseudoTable;a.on(P.FastTable.EVT_RENDERED,function(){if(!a.editing){!(B.subIndex in a.rows)&&(B.subIndex=0);var t=a.rowGet(B.subIndex);t?(t.selected=!0,setTimeout(function(){B.subRefresh(t.data),n&&n.setPresentSelected(B.subIndex)},200)):B.mobileModal&&(B.mobileModal.isShow=!1)}});var i=B;a.click.add(".section-inner-wrapper.pseudo-table tbody tr[data-index]",function(){var t=parseInt(this.dataset.index),e=a.rowGet(t);i.subIndex=t,e&&e.selected?(i.subRefresh(e.data),n&&n.setPresentSelected(t)):i.mobileModal&&(i.mobileModal.isShow=!1)})}}}return Object.defineProperty(k.prototype,"defaultData",{get:function(){return this._defaultData?this._defaultData.map(function(t){return Object.assign({},t||{})}):null},enumerable:!0,configurable:!0}),k.prototype.subRefresh=function(t){var e=this.bwEl,a=e.subTableList&&e.subTableList[0],n=this.main,i=n.ftable;if(!q.isEmpty(a)){var r=t||(i.selectedRowsData[0]||{}),o=Object.assign({},n.ajaxData,R.BwRule.varList(a.dataAddr.varList,r));if(delete o.queryoptionsparam,this.sub)this.mobileModal&&(this.mobileModal.isShow=!0),this.sub.refresh(o).catch();else{var l=z(e.tableAddr).subParam;this.subInit(a,l,o)}}},k.prototype.subInit=function(t,e,a){var n=this,i=this.main.container,r=null;(V.classAdd(i,"table-module-has-sub"),q.isMb)?(r=new L.Modal({className:"modal-mbPage sub-table",isBackground:!1,height:"60%",width:"75%",isMb:!1,position:"right",onClose:function(){var t=n.main.ftable.pseudoTable;t&&t.clearPresentSelected(),n.active.isMain=!0}}),this.main.subBtns.box&&(r.wrapper.style.bottom="36px"),r.wrapper.style.left="auto",r.wrapper.style.top="auto",r.wrapper.style.bottom="40px",i=new l.MbPage({headerHeight:"30px",container:r.bodyWrapper,title:t.caption,right:[{icon:"close",onClick:function(){r.isShow=!1}}],left:[{icon:"fa fa-expand",iconPre:"mui-icon",onClick:function(){V.classToggle(r.wrapper,"full-screen"),V.classToggle(r.wrapper,"sub-table")}}]}).bodyEl,this.mobileModal=r):q.isEmpty(this.dragLine)&&(this.dragLine=h("div",{className:"drag-line"}),V.append(i,this.dragLine));this.sub=new o.BwSubTableModule({container:i,ui:t,editParam:e,ajaxData:a,isSub:!0,tableModule:this}),!q.isMb&&this.draggedEvent.on(),this.subWrapper=q.isMb?r.wrapper:this.sub.wrapper,this.active.on()},k.prototype.refresh=function(t){return this.main.refresh(t)},k.initAssignData=function(t,e){return R.BwRule.Ajax.fetch(K.siteUrl+R.BwRule.reqAddr(t,e),{cache:!0})},Object.defineProperty(k.prototype,"btnWrapper",{get:function(){var e=this;if(!this._btnWrapper){var t=this.main;if(q.isMb){if(V.classAdd(this.main.wrapper,"has-footer-btn"),this._btnWrapper=h("footer",{className:"mui-bar mui-bar-footer"}),V.append(this.main.wrapper,this._btnWrapper),this.editable&&q.isNotEmpty(this.bwEl.subButtons)){var a=h("div",{className:"all-btn"});new n.CheckBox({className:"edit-toggle",container:this._btnWrapper,onClick:function(t){e.main.subBtns.box.isShow=!t,e.editBtns.box.isShow=t}}),V.append(this._btnWrapper,a),this._btnWrapper=a}}else this._btnWrapper=t.ftable.btnWrapper}return this._btnWrapper},enumerable:!0,configurable:!0}),k.prototype.destroy=function(){this.mobileModal&&this.mobileModal.destroy(),this.draggedEvent.off(),V.remove(this.dragLine),this.main&&this.main.destroy(),this.sub&&this.sub.destroy(),this.main=null,this.sub=null,this.edit=null,this.bwEl=null,this._btnWrapper=null,this.dragLine=null},k.EVT_EDIT_SAVE="__event_edit_save__",k}();function z(t){var e={mainParam:null,subParam:null};return t&&Array.isArray(t.param)&&t.param.forEach(function(t){"sub"===t.type?e.subParam=t:"main"===t.type&&(e.mainParam=t)}),e}t.NewTableModule=e}),define("BwInventoryBtnFun",["require","exports","Modal"],function(t,e,w){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var g,T=BW.CONF,C=G.tools,E=G.Shell,D=BW.sys,A=G.Ajax;function M(t,e,a){var n=e.ftable,i=n.data,r={},o=a.classify.toUpperCase(),l=a.amount.toUpperCase();i.forEach(function(t,e){r[t[o]]={rowData:t,index:e}});for(var s=0,c=t;s<c.length;s++){var u=c[s],d=r[u.field];if(!C.isEmpty(d)){var f=d.rowData,p=d.index,m=n.rowGet(p);if(f[l]=u.count,a.ruleFields)for(var b=0,h=a.ruleFields;b<h.length;b++){var y=h[b],v=C.str.parseTpl(y.amountRule.toUpperCase(),f);f[y.amountField.toUpperCase()]=C.calc(v),m.data=f}else m.data=f}}}e.InventoryBtn=function(t,e){var a,n,i,u,d,r,o,l,s,c,f,p,m,b,h,y=t.data;if("rfid_down"===y.openType){var v="";e.ui.subButtons.forEach(function(t,e){"rfid_up"==t.openType&&(v=t.actionAddr.dataAddr)}),console.log(v),(c=y.actionAddr.dataAddr+"",f=v+"",p=t,m=e,b=C.url.addObj(T.siteUrl+f,m.ajaxData),h=C.url.addObj(T.siteUrl+c,m.ajaxData),new Promise(function(e){p.isDisabled=!0;var a="";m.ui.subButtons.forEach(function(t,e){"rfid_down"==t.openType&&(a=t.inventoryKey)}),a&&G.Shell.inventory.loadData(h,b,a,function(t){e()})})).then(function(){e.rfidDownAndUpInitHead(),t.isDisabled=!1,t.content=t.content.replace(/下载/g,"更新")})}else"rfid_up"===y.openType?(o=y.actionAddr.dataAddr,s="",(l=e).ui.subButtons.forEach(function(t,e,a){"rfid_up"==t.openType&&(s=t.inventoryKey)}),s&&G.Shell.inventory.uploadData(C.url.addObj(T.siteUrl+o,l.ajaxData),s,function(t){})):"rfid_begin"===y.openType||"rfid_stop"===y.openType?function(t,e,a){if("rfid_begin"===t){var n=a.ui.rfidCols;if(n.calc.when,G.tools.isEmpty(n))return;e.content="结束扫描",e.data.openType="rfid_stop",g=setInterval(function(){A.fetch(T.ajaxUrl.rfidLoginTime)},54e4),n.classify&&(G.Shell.inventory.startCheck({memSearch:"S1",memTime:"20",field:n.classify.toUpperCase()},function(t){M(t.data,a,n)}),a.rfidColthead())}else{var i=a.ui.rfidCols;G.Shell.inventory.stopCheck({},function(t){w.Modal.alert("结束扫描")}),e.content="开始",e.data.openType="rfid_begin",E.inventory.columnCountOff({},1,i.inventoryKey,function(t){}),clearInterval(g)}}(y.openType,t,e):"rfid_find"===y.openType||"rfid_nofind"===y.openType?(a=y.openType,n=t,u=(i=e).ftable,d=i.ui.rfidCols,r=u.columnGet(d.searchField.toUpperCase()).data,G.tools.isEmpty(r)?w.Modal.alert("无EPC码数据"):"rfid_find"===a?(E.inventory.findGoods(r,function(t){for(var e=t.data,a=["无信号","弱","中","强","超强"],n=0,i=u.rows;n<i.length;n++)for(var r=i[n],o=r.data,l=0,s=e;l<s.length;l++){var c=s[l];if(o[d.searchField.toUpperCase()]===c.epc){o[d.amount.toUpperCase()]=c.isScan,o[d.wifiField.toUpperCase()]=a[c.strength],r.data=o;break}}}),n.content="停止找货",n.data.openType="rfid_nofind"):(E.inventory.stopFind({},function(t){w.Modal.alert("停止找货")}),n.content="开始找货",n.data.openType="rfid_find")):"rfid_import"===y.openType&&D.window.open({url:C.url.addObj(T.siteUrl+y.actionAddr.dataAddr,{param1:JSON.stringify(e.ajaxData)})})},e.ontimeRefresh=M});